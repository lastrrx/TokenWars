<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TokenWars Advanced Admin Panel - Production Ready</title>
    <link rel="stylesheet" href="admin.css">

    <!-- Supabase Client -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <!-- Browser-compatible Buffer polyfill (SAME AS INDEX.HTML) -->
    <script>
    // Simple Buffer polyfill for browser
    if (typeof Buffer === 'undefined') {
        window.Buffer = {
            from: function(data, encoding) {
                if (typeof data === 'string') {
                    const encoder = new TextEncoder();
                    return new Uint8Array(encoder.encode(data));
                }
                if (Array.isArray(data)) {
                    return new Uint8Array(data);
                }
                return new Uint8Array(data);
            },
            alloc: function(size, fill) {
                const buffer = new Uint8Array(size);
                if (fill !== undefined) {
                    buffer.fill(fill);
                }
                return buffer;
            },
            concat: function(arrays) {
                const totalLength = arrays.reduce((sum, arr) => sum + arr.length, 0);
                const result = new Uint8Array(totalLength);
                let offset = 0;
                for (const arr of arrays) {
                    result.set(arr, offset);
                    offset += arr.length;
                }
                return result;
            }
        };
    }
    </script>

    <!-- Solanaw web3 js -->
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    
    <!-- Chart.js for analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Blockchain Dependency Validation - ADD THIS -->
    <script>
    window.addEventListener('load', function() {
        // Check if blockchain dependencies loaded
        if (typeof solanaWeb3 !== 'undefined') {
            console.log('‚úÖ [ADMIN] Solana Web3.js loaded successfully');
            window.adminBlockchainAvailable = true;
        } else {
            console.error('‚ùå [ADMIN] Solana Web3.js failed to load');
            window.adminBlockchainAvailable = false;
        }
        
        if (typeof supabase !== 'undefined') {
            console.log('‚úÖ [ADMIN] Supabase loaded successfully');
        } else {
            console.error('‚ùå [ADMIN] Supabase failed to load');
        }
    });
// Emergency Cleanup Modal Functions
let targetCompetitionForCleanup = null;

function showEmergencyCleanupModal(competitionId) {
    console.log('üö® Opening emergency cleanup modal for:', competitionId);
    console.log('üîç Competition ID type:', typeof competitionId);
    console.log('üîç Competition ID value:', JSON.stringify(competitionId));
    
    // Validate competition ID
    if (!competitionId || competitionId === 'null' || competitionId === 'undefined') {
        console.error('‚ùå Invalid competition ID passed to modal:', competitionId);
        showAdminNotification('Invalid competition ID', 'error');
        return;
    }
    
    // Store competition ID globally AND on window for extra safety
    targetCompetitionForCleanup = competitionId;
    window.targetCompetitionForCleanup = competitionId;
    
    console.log('‚úÖ Target competition set to:', targetCompetitionForCleanup);
    
    // Update modal content
    document.getElementById('targetCompetitionId').textContent = competitionId;
    document.getElementById('confirmCompetitionId').value = '';
    document.getElementById('confirmCleanupBtn').disabled = true;
    document.getElementById('emergencyCleanupModal').style.display = 'flex';
    
    // Remove any existing event listeners to prevent duplicates
    const confirmInput = document.getElementById('confirmCompetitionId');
    const newConfirmInput = confirmInput.cloneNode(true);
    confirmInput.parentNode.replaceChild(newConfirmInput, confirmInput);
    
    // Add fresh event listener for input validation
    newConfirmInput.addEventListener('input', function(e) {
        const isMatch = e.target.value === competitionId;
        const confirmBtn = document.getElementById('confirmCleanupBtn');
        confirmBtn.disabled = !isMatch;
        
        console.log('üîç Input validation - Match:', isMatch, 'Input:', e.target.value, 'Expected:', competitionId);
        
        if (isMatch) {
            e.target.style.borderColor = '#10b981';
            e.target.style.backgroundColor = 'rgba(16, 185, 129, 0.1)';
        } else {
            e.target.style.borderColor = 'var(--admin-border)';
            e.target.style.backgroundColor = 'var(--admin-bg)';
        }
    });
    
    // Focus the input
    setTimeout(() => newConfirmInput.focus(), 100);
}

function closeEmergencyCleanupModal() {
    console.log('üîç Closing emergency cleanup modal');
    
    document.getElementById('emergencyCleanupModal').style.display = 'none';
    
    // Reset input styles
    const confirmInput = document.getElementById('confirmCompetitionId');
    if (confirmInput) {
        confirmInput.style.borderColor = 'var(--admin-border)';
        confirmInput.style.backgroundColor = 'var(--admin-bg)';
        confirmInput.value = '';
    }
    
    // Reset button state
    const confirmBtn = document.getElementById('confirmCleanupBtn');
    if (confirmBtn) {
        confirmBtn.disabled = true;
        confirmBtn.textContent = 'üö® Confirm Emergency Cleanup';
    }
    
    // Clear target ONLY after use (moved to end of executeEmergencyCleanup)
    // targetCompetitionForCleanup = null;  // DON'T clear here!
}

async function executeEmergencyCleanup() {
    console.log('üîç Execute emergency cleanup called');
    console.log('üîç targetCompetitionForCleanup:', targetCompetitionForCleanup);
    console.log('üîç window.targetCompetitionForCleanup:', window.targetCompetitionForCleanup);
    
    // Use fallback from window if main variable is lost
    const competitionToCleanup = targetCompetitionForCleanup || window.targetCompetitionForCleanup;
    
    if (!competitionToCleanup) {
        console.error('‚ùå No competition selected for cleanup');
        showAdminNotification('No competition selected for cleanup', 'error');
        return;
    }
    
    const confirmedId = document.getElementById('confirmCompetitionId').value;
    console.log('üîç Confirmed ID:', confirmedId);
    console.log('üîç Expected ID:', competitionToCleanup);
    
    if (confirmedId !== competitionToCleanup) {
        console.error('‚ùå Competition ID mismatch');
        showAdminNotification('Competition ID does not match', 'error');
        return;
    }
    
    try {
        // Show loading state
        const confirmBtn = document.getElementById('confirmCleanupBtn');
        const originalText = confirmBtn.textContent;
        confirmBtn.textContent = '‚è≥ Processing...';
        confirmBtn.disabled = true;
        
        showAdminNotification('Executing emergency cleanup...', 'info');
        
        console.log('üö® Executing emergency cleanup for:', competitionToCleanup);
        
        // Call the emergency cleanup function from admin.js BEFORE closing modal
        await window.emergencyCleanupCompetition(competitionToCleanup);
        
        // NOW close the modal after successful execution
        closeEmergencyCleanupModal();
        
        // Clear the target variables NOW that we're done
        targetCompetitionForCleanup = null;
        window.targetCompetitionForCleanup = null;
        
        console.log('‚úÖ Emergency cleanup completed successfully');
        
        // Refresh the competitions display
        if (typeof loadCompetitionsManagementWithDiagnostics === 'function') {
            await loadCompetitionsManagementWithDiagnostics();
        }
        
    } catch (error) {
        console.error('‚ùå Emergency cleanup failed:', error);
        showAdminNotification(`Emergency cleanup failed: ${error.message}`, 'error');
        
        // Reset button state on error
        const confirmBtn = document.getElementById('confirmCleanupBtn');
        if (confirmBtn) {
            confirmBtn.textContent = 'üö® Confirm Emergency Cleanup';
            confirmBtn.disabled = false;
        }
    }
}
        
        // Export functions globally for onclick handlers
        window.showEmergencyCleanupModal = showEmergencyCleanupModal;
        window.closeEmergencyCleanupModal = closeEmergencyCleanupModal;
        window.executeEmergencyCleanup = executeEmergencyCleanup;

    </script>

    <style>
        /* CSS Variables for Admin Theme */
        :root {
            --admin-bg: #0f172a;
            --admin-surface: #1e293b;
            --admin-border: #334155;
            --admin-text: #f1f5f9;
            --admin-text-secondary: #94a3b8;
            --admin-primary: #8b5cf6;
            --admin-success: #22c55e;
            --admin-warning: #f59e0b;
            --admin-error: #ef4444;
            --admin-info: #3b82f6;
        }

        .competition-parameter {
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--admin-border);
            color: var(--admin-text);
        }
        
        .competition-parameter:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .competition-parameter strong {
            color: var(--admin-text-secondary);
            display: inline-block;
            min-width: 120px;
        }

        /* Enhanced Production Styles */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 5000;
            color: #f1f5f9;
            font-size: 1.125rem;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(139, 92, 246, 0.3);
            border-top: 4px solid #8b5cf6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .admin-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(31, 41, 55, 0.95);
            border: 1px solid;
            border-radius: 0.5rem;
            padding: 1rem 1.5rem;
            color: #f3f4f6;
            z-index: 4000;
            min-width: 300px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .admin-notification.success { border-color: #22c55e; }
        .admin-notification.error { border-color: #ef4444; }
        .admin-notification.warning { border-color: #f59e0b; }
        .admin-notification.info { border-color: #3b82f6; }

        .admin-notification button {
            background: none;
            border: none;
            color: #9ca3af;
            font-size: 1.2rem;
            cursor: pointer;
            margin-left: 1rem;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-indicator.healthy { background: #22c55e; }
        .status-indicator.error { background: #ef4444; }
        .status-indicator.stale { background: #f59e0b; }
        .status-indicator.unknown { background: #6b7280; }

        /* Enhanced Status Items */
        .status-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--admin-surface);
            border: 1px solid var(--admin-border);
            border-radius: 8px;
            transition: all 0.2s ease;
            margin-bottom: 0.5rem;
        }
        
        .status-item:hover {
            background: rgba(139, 92, 246, 0.05);
            border-color: rgba(139, 92, 246, 0.3);
        }
        
        .status-item:last-child {
            margin-bottom: 0;
        }
        
        .status-text {
            flex: 1;
            font-weight: 500;
            color: var(--admin-text);
        }
        
        .status-details {
            font-size: 0.875rem;
            color: var(--admin-text-secondary);
            font-weight: 400;
        }
        
        .status-details.connected {
            color: var(--admin-success);
        }
        
        .status-details.disconnected {
            color: var(--admin-error);
        }
        
        .status-details.initializing {
            color: var(--admin-warning);
        }
        
        /* Enhanced Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: var(--admin-surface);
            border: 1px solid var(--admin-border);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.2s ease;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.15);
        }

        .metric-card h3 {
            color: var(--admin-text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
            margin: 0 0 0.75rem 0;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .metric-value {
            color: var(--admin-text);
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
            line-height: 1;
        }

        .metric-change {
            font-size: 0.75rem;
            margin-top: 0.5rem;
            font-weight: 500;
        }

        .metric-change.positive { color: var(--admin-success); }
        .metric-change.negative { color: var(--admin-error); }

        /* Cache Health Grid */
        .cache-health-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .cache-health-card {
            background: var(--admin-bg);
            border: 1px solid var(--admin-border);
            border-radius: 8px;
            padding: 1.25rem;
            text-align: center;
        }

        .cache-metric {
            font-size: 1.875rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            line-height: 1;
        }

        .cache-metric.excellent { color: var(--admin-success); }
        .cache-metric.good { color: var(--admin-info); }
        .cache-metric.warning { color: var(--admin-warning); }
        .cache-metric.error { color: var(--admin-error); }

        .cache-health-card .label {
            color: var(--admin-text-secondary);
            font-size: 0.8125rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Production Enhanced Sections */
        .production-section {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(59, 130, 246, 0.1));
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            position: relative;
        }

        .production-badge {
            position: absolute;
            top: -8px;
            right: 1rem;
            background: linear-gradient(135deg, #22c55e, #3b82f6);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Enhanced Automation Styles */
        .automation-status {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
            padding: 1.25rem;
            background: var(--admin-bg);
            border-radius: 10px;
            border: 1px solid var(--admin-border);
        }

        .automation-status.active {
            border-left: 4px solid var(--admin-success);
            background: rgba(34, 197, 94, 0.05);
        }

        .automation-status.inactive {
            border-left: 4px solid var(--admin-error);
            background: rgba(239, 68, 68, 0.05);
        }

        .automation-controls {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        /* Enhanced Parameter Grid */
        .automation-parameters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .parameter-control {
            background: var(--admin-bg);
            border: 1px solid var(--admin-border);
            border-radius: 10px;
            padding: 1.25rem;
            transition: all 0.2s ease;
        }

        .parameter-control:hover {
            border-color: var(--admin-primary);
            transform: translateY(-1px);
        }

        .parameter-control label {
            display: block;
            margin-bottom: 0.75rem;
            font-weight: 600;
            color: var(--admin-text-secondary);
            font-size: 0.8125rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .parameter-input {
            width: 100%;
            padding: 0.75rem;
            background: var(--admin-surface);
            border: 1px solid var(--admin-border);
            border-radius: 6px;
            color: var(--admin-text);
            font-size: 1rem;
            font-weight: 600;
            text-align: center;
            transition: all 0.2s ease;
        }

        .parameter-input:focus {
            outline: none;
            border-color: var(--admin-primary);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        .parameter-value {
            margin-top: 0.75rem;
            text-align: center;
            line-height: 1.4;
        }

        .parameter-value > div:first-child {
            font-size: 1rem;
            font-weight: 700;
            color: var(--admin-primary);
            margin-bottom: 0.25rem;
        }

        .parameter-value > div:last-child {
            font-size: 0.75rem;
            color: var(--admin-text-secondary);
            font-weight: 500;
        }

        /* Enhanced Button Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            justify-content: center;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--admin-primary), #7c3aed);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--admin-success), #16a34a);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--admin-error), #dc2626);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--admin-warning), #ea580c);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, var(--admin-info), #2563eb);
            color: white;
        }

        .btn-secondary {
            background: var(--admin-surface);
            color: var(--admin-text-secondary);
            border: 1px solid var(--admin-border);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Cache Controls Grid */
        .cache-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            align-items: center;
        }

        /* Batch Controls */
        .batch-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            align-items: center;
            margin-bottom: 1rem;
        }

        .selected-count {
            margin-left: auto;
            padding: 0.5rem 1rem;
            background: var(--admin-bg);
            border: 1px solid var(--admin-border);
            border-radius: 6px;
            font-size: 0.875rem;
            color: var(--admin-text-secondary);
        }

        /* Enhanced Table Styles */
        .table-container {
            background: var(--admin-surface);
            border: 1px solid var(--admin-border);
            border-radius: 10px;
            overflow: hidden;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
        }

        .admin-table th {
            background: var(--admin-bg);
            color: var(--admin-text-secondary);
            font-weight: 600;
            font-size: 0.8125rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--admin-border);
        }

        .admin-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--admin-border);
            color: var(--admin-text);
            font-size: 0.875rem;
        }

        .admin-table tr:hover {
            background: rgba(139, 92, 246, 0.05);
        }

        /* Security Warning */
        .security-warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--admin-warning);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            color: var(--admin-warning);
        }

        /* Download Section */
        .download-section {
            background: var(--admin-surface);
            border: 1px solid var(--admin-border);
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1rem;
        }

        .download-section h4 {
            margin: 0 0 1rem 0;
            color: var(--admin-text);
            font-size: 1rem;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }

        .modal-content {
            background: var(--admin-surface);
            border: 1px solid var(--admin-border);
            border-radius: 12px;
            padding: 2rem;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: var(--admin-text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .close-modal:hover {
            background: var(--admin-bg);
            color: var(--admin-text);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .automation-parameters {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
            
            .metrics-grid {
                grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .automation-parameters {
                grid-template-columns: 1fr;
            }
            
            .automation-status {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .automation-controls {
                width: 100%;
                justify-content: center;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .cache-health-grid {
                grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            }

            .cache-controls, .batch-controls {
                justify-content: center;
            }

            .selected-count {
                margin-left: 0;
                width: 100%;
                text-align: center;
            }
        }

        @media (max-width: 480px) {
            .production-section {
                padding: 1rem;
            }
            
            .parameter-control {
                padding: 1rem;
            }
            
            .btn {
                padding: 0.625rem 1rem;
                font-size: 0.8125rem;
            }
        }
    </style>
</head>
<body>
    <!-- Admin Authentication Screen -->
    <div id="auth-screen" class="auth-container">
        <div class="auth-box">
            <h1>üöÄ TokenWars Production Admin Panel</h1>
            <p class="auth-description">Live Data Management & Competition Automation</p>
            
            <div class="auth-steps">
                <div class="auth-step" id="step-wallet">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <h3>Connect Admin Wallet</h3>
                        <button id="connect-admin-wallet" class="btn btn-primary">
                            Connect Wallet
                        </button>
                        <div id="wallet-status" class="wallet-status hidden">
                            <span class="wallet-address"></span>
                            <span class="status-icon">‚úì</span>
                        </div>
                    </div>
                </div>
                
                <div class="auth-step disabled" id="step-pin">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <h3>Enter Admin PIN</h3>
                        <input type="password" id="admin-pin" placeholder="Enter 6-digit PIN" 
                               maxlength="6" pattern="[0-9]{6}" disabled>
                        <button id="verify-pin" class="btn btn-primary" disabled>
                            Verify Access
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="auth-error" class="error-message hidden"></div>
        </div>
    </div>

    <!-- Main Admin Panel -->
    <div id="admin-panel" class="admin-panel hidden">
        <!-- Enhanced Admin Header -->
        <header class="admin-header">
            <div class="header-container">
                <h1>üèÜ TokenWars Production Admin Panel</h1>
                <div class="header-actions">
                    <div class="real-time-indicator">
                        <div class="real-time-pulse"></div>
                        <span>Live Data</span>
                    </div>
                    <div id="token-update-status" class="token-update-status">
                        <span class="status-indicator unknown"></span>
                        <span>System Status: Loading...</span>
                    </div>
                    <span class="admin-wallet"></span>
                    <button id="logout" class="btn btn-secondary">Logout</button>
                </div>
            </div>
        </header>

        <!-- Enhanced Admin Navigation -->
        <nav class="admin-nav">
            <ul class="nav-menu">
                <li><a href="#dashboard" class="nav-item active">üìä Dashboard</a></li>
                <li><a href="#cache-management" class="nav-item">üîß Cache Management</a></li>
                <li><a href="#token-approval" class="nav-item">‚úÖ Token Approval</a></li>
                <li><a href="#blacklist-management" class="nav-item">üö´ Blacklist Management</a></li>
                <li><a href="#pair-optimization" class="nav-item">üìà Pair Analytics</a></li>
                <li><a href="#competitions" class="nav-item">üèÅ Competition Management</a></li>
                <li><a href="#tokens" class="nav-item">ü™ô Token Management</a></li>
                <li><a href="#analytics" class="nav-item">üìä Advanced Analytics</a></li>
            </ul>
        </nav>

        <!-- Enhanced Admin Content -->
        <main class="admin-content">
            <!-- Enhanced Dashboard Section -->
            <section id="dashboard" class="admin-section">
                <h2>üéõÔ∏è Live System Dashboard</h2>
                
                <!-- Enhanced Key Metrics -->
                <div class="metrics-grid" id="dashboard-metrics">
                    <div class="metric-card">
                        <h3>üí∞ Total Volume</h3>
                        <p class="metric-value" id="total-volume">0 SOL</p>
                        <p class="metric-change positive">Live</p>
                    </div>
                    <div class="metric-card">
                        <h3>üèÉ Active Competitions</h3>
                        <p class="metric-value" id="active-competitions">0</p>
                        <p class="metric-change positive">Real-time</p>
                    </div>
                    <div class="metric-card">
                        <h3>ü™ô Total Tokens</h3>
                        <p class="metric-value" id="total-tokens">0</p>
                        <p class="metric-change positive">Cache</p>
                    </div>
                    <div class="metric-card">
                        <h3>‚úÖ Approved Tokens</h3>
                        <p class="metric-value" id="approved-tokens">0</p>
                        <p class="metric-change">Database</p>
                    </div>
                    <div class="metric-card">
                        <h3>üö´ Blacklisted</h3>
                        <p class="metric-value" id="blacklisted-tokens">0</p>
                        <p class="metric-change negative">Active</p>
                    </div>
                    <div class="metric-card">
                        <h3>üîó Token Pairs</h3>
                        <p class="metric-value" id="active-pairs">0</p>
                        <p class="metric-change positive">Generated</p>
                    </div>
                </div>

                <!-- Enhanced System Status -->
                <div class="system-status">
                    <h3>üîß System Health Status</h3>
                    <div class="status-grid">
                        <!-- Status items will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Production Quick Actions -->
                <div class="production-section">
                    <div class="production-badge">Live Data</div>
                    <h3>‚ö° Quick Actions</h3>
                    <div class="cache-controls">
                        <button class="btn btn-primary" onclick="quickCacheRefresh()">
                            üîÑ Refresh Cache
                        </button>
                        <button class="btn btn-secondary" onclick="viewPendingApprovals()">
                            ‚úÖ Pending Approvals (<span id="pending-count">0</span>)
                        </button>
                        <button class="btn btn-warning" onclick="reviewBlacklist()">
                            üö´ Review Blacklist
                        </button>
                        <button class="btn btn-info" onclick="viewPairAnalytics()">
                            üìà Pair Analytics
                        </button>
                    </div>
                </div>

                <!-- Enhanced Recent Activity -->
                <div class="recent-activity">
                    <h3>üìù Recent Activity</h3>
                    <div id="activity-feed" class="activity-feed">
                        <!-- Activity items will be loaded here -->
                    </div>
                </div>
            </section>

            <!-- Cache Management Section -->
            <section id="cache-management" class="admin-section hidden">
                <h2>üîß Live Cache Management</h2>
                
                <!-- Cache Health Overview -->
                <div class="production-section">
                    <div class="production-badge">Real-time</div>
                    <h3>üìä Token Cache Health</h3>
                    <div class="cache-health-grid">
                        <div class="cache-health-card">
                            <div class="cache-metric excellent" id="token-cache-hit">0%</div>
                            <div class="label">Cache Hit Rate</div>
                        </div>
                        <div class="cache-health-card">
                            <div class="cache-metric good" id="cache-response-time">0ms</div>
                            <div class="label">Avg Response Time</div>
                        </div>
                        <div class="cache-health-card">
                            <div class="cache-metric warning" id="cache-size">0MB</div>
                            <div class="label">Cache Size</div>
                        </div>
                        <div class="cache-health-card">
                            <div class="cache-metric good" id="fresh-tokens">0</div>
                            <div class="label">Fresh Tokens</div>
                        </div>
                    </div>
                </div>

                <!-- Manual Cache Controls -->
                <div class="production-section">
                    <h3>üõ†Ô∏è Cache Controls</h3>
                    <div class="cache-controls">
                        <button class="btn btn-primary" onclick="refreshTokenCache()">
                            ü™ô Refresh Token Cache
                        </button>
                        <button class="btn btn-secondary" onclick="clearStaleCache()">
                            üóëÔ∏è Clear Stale Cache
                        </button>
                        <button class="btn btn-success" onclick="optimizeCache()">
                            ‚ö° Optimize Cache
                        </button>
                        <button class="btn btn-info" onclick="viewCacheAnalytics()">
                            üìä Cache Analytics
                        </button>
                    </div>
                    
                    <!-- Cache Progress Indicator -->
                    <div id="cache-progress" class="hidden">
                        <h4>Cache Operation Progress</h4>
                        <div class="progress-bar">
                            <div class="progress-fill" id="cache-progress-bar" style="width: 0%"></div>
                        </div>
                        <div id="cache-progress-text">Initializing...</div>
                    </div>
                </div>
            </section>

            <!-- Token Approval Section -->
            <section id="token-approval" class="admin-section hidden">
                <h2>‚úÖ Manual Token Approval</h2>
                
                <!-- Approval Statistics -->
                <div class="production-section">
                    <h3>üìä Approval Statistics</h3>
                    <div class="cache-health-grid">
                        <div class="cache-health-card">
                            <div class="cache-metric good" id="pending-approvals">0</div>
                            <div class="label">Pending Approvals</div>
                        </div>
                        <div class="cache-health-card">
                            <div class="cache-metric excellent" id="approval-rate">0%</div>
                            <div class="label">Approval Rate</div>
                        </div>
                        <div class="cache-health-card">
                            <div class="cache-metric good" id="avg-review-time">0h</div>
                            <div class="label">Avg Review Time</div>
                        </div>
                        <div class="cache-health-card">
                            <div class="cache-metric warning" id="total-approved">0</div>
                            <div class="label">Total Approved</div>
                        </div>
                    </div>
                </div>

                <!-- Pending Approval Queue -->
                <div class="production-section">
                    <h3>‚è≥ Pending Approval Queue</h3>
                    <div class="approval-queue" id="approval-queue">
                        <!-- Approval items will be populated here -->
                    </div>
                </div>
            </section>

            <!-- Blacklist Management Section -->
            <section id="blacklist-management" class="admin-section hidden">
                <h2>üö´ Blacklist Management & Analytics</h2>
                
                <!-- Blacklist Overview -->
                <div class="production-section">
                    <h3>üìä Blacklist Analytics</h3>
                    <div class="cache-health-grid">
                        <div class="cache-health-card">
                            <div class="cache-metric warning" id="total-blacklisted">0</div>
                            <div class="label">Total Blacklisted</div>
                        </div>
                    </div>
                </div>

                <!-- Whitelist Operations -->
                <div class="production-section">
                    <div class="production-badge">New Feature</div>
                    <h3>‚úÖ Whitelist Operation</h3>
                    <p>Remove tokens from blacklist and add back to approval queue.</p>
                    <div class="cache-controls">
                        <button class="btn btn-secondary" onclick="exportBlacklist()">
                            üì§ Export Blacklist
                        </button>
                    </div>
                </div>

                <!-- Blacklist Categories -->
                <div class="production-section">
                    <h3>üìÇ Blacklist Categories</h3>
                    
                    <!-- Manual Blacklist -->
                    <div class="blacklist-category">
                        <div class="blacklist-header">
                            <h4>üë®‚Äçüíº Manual Blacklist</h4>
                            <div class="blacklist-count" id="manual-blacklist-count">0</div>
                        </div>
                        <div class="blacklist-items" id="manual-blacklist">
                            <!-- Items will be populated here -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Pair Analytics Section (Renamed from Optimization) -->
            <section id="pair-optimization" class="admin-section hidden">
                <h2>üìà Token Pair Analytics</h2>
                
                <!-- Pair Overview -->
                <div class="production-section">
                    <h3>üìä Pair Performance Overview</h3>
                    <div class="cache-health-grid">
                        <div class="cache-health-card">
                            <div class="cache-metric excellent" id="total-pairs">0</div>
                            <div class="label">Total Pairs</div>
                        </div>
                        <div class="cache-health-card">
                            <div class="cache-metric good" id="active-pairs-count">0</div>
                            <div class="label">Active Pairs</div>
                        </div>
                        <div class="cache-health-card">
                            <div class="cache-metric warning" id="avg-market-cap-diff">0%</div>
                            <div class="label">Avg Market Cap Diff</div>
                        </div>
                        <div class="cache-health-card">
                            <div class="cache-metric excellent" id="avg-compatibility">0%</div>
                            <div class="label">Avg Compatibility</div>
                        </div>
                    </div>
                </div>

                <!-- Last Update Info -->
                <div class="production-section">
                    <h3>üïí Pair Generation Status</h3>
                    <div class="automation-status" id="pair-generation-status">
                        <div class="status-indicator healthy"></div>
                        <div>
                            <div><strong>Last Update:</strong> <span id="last-pair-update">Never</span></div>
                            <div><strong>Next Update:</strong> <span id="next-pair-update">Every 5 minutes</span></div>
                            <div><strong>Edge Function:</strong> manage-token-pairs (Automated)</div>
                        </div>
                    </div>
                </div>

                <!-- Pair Analytics Table -->
                <div class="production-section">
                    <h3>üìã Active Token Pairs</h3>
                    <div class="table-container">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>ü™ô Token A</th>
                                    <th>ü™ô Token B</th>
                                    <th>üìä Market Cap Ratio</th>
                                    <th>üéØ Compatibility</th>
                                    <th>üìà Category</th>
                                    <th>üïí Created</th>
                                    <th>üìä Usage</th>
                                </tr>
                            </thead>
                            <tbody id="pairs-analytics-tbody">
                                <tr>
                                    <td colspan="7">Loading pair analytics...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Pair Performance Charts -->
                <div class="production-section">
                    <h3>üìà Pair Performance Analytics</h3>
                    <div class="performance-chart">
                        <canvas id="pair-performance-chart"></canvas>
                    </div>
                </div>
            </section>

            <!-- Competition Management Section -->
            <section id="competitions" class="admin-section hidden">
                <h2>üèÅ Competition Management & Automation</h2>
                
                <!-- Competition Statistics -->
                <div class="production-section">
                    <h3>üìä Competition Overview</h3>
                    <div class="cache-health-grid">
                        <div class="cache-health-card">
                            <div class="cache-metric good" id="total-competitions-stat">0</div>
                            <div class="cache-metric-label">Total Competitions</div>
                        </div>
                        <div class="cache-health-card">
                            <div class="cache-metric excellent" id="active-competitions-stat">0</div>
                            <div class="cache-metric-label">Active Competitions</div>
                        </div>
                        <div class="cache-health-card">
                            <div class="cache-metric warning" id="total-participants-stat">0</div>
                            <div class="cache-metric-label">Total Bets Placed</div>
                        </div>
                        <div class="cache-health-card">
                            <div class="cache-metric excellent" id="total-volume-stat">0 SOL</div>
                            <div class="cache-metric-label">Total Volume</div>
                        </div>
                    </div>
                </div>

                <!-- Competition Automation -->
                <div class="production-section">
                    <div class="production-badge">Automated</div>
                    <h3>ü§ñ Competition Automation</h3>
                    
                    <!-- Security Warning -->
                    <div class="security-warning">
                        <strong>‚ö†Ô∏è Security Notice:</strong> Competition automation requires admin wallet verification. 
                        Only wallets in the admin_users table can start/stop automation.
                    </div>
                    
                    <!-- Automation Status -->
                    <div class="automation-status" id="automation-status">
                        <div class="status-indicator error"></div>
                        <div>
                            <div><strong>Status:</strong> <span id="automation-current-status">Stopped</span></div>
                            <div><strong>Next Competition:</strong> <span id="next-competition-time">Not scheduled</span></div>
                            <div><strong>Competitions Today:</strong> <span id="competitions-today">0</span></div>
                        </div>
                        <div class="automation-controls">
                            <button class="btn btn-success" id="start-automation-btn" onclick="startCompetitionAutomation()">
                                ‚ñ∂Ô∏è Start Automation
                            </button>
                            <button class="btn btn-danger" id="stop-automation-btn" onclick="stopCompetitionAutomation()" disabled>
                                ‚èπÔ∏è Stop Automation
                            </button>
                        </div>
                    </div>

                    <!-- Automation Parameters -->
                    <div class="automation-parameters">
                        <div class="parameter-control">
                            <label>Competitions per Day</label>
                            <input type="number" class="parameter-input" id="competitions-per-day" 
                                   min="1" max="24" value="4">
                            <div class="parameter-value">Every 6 hours</div>
                        </div>
                        
                        <div class="parameter-control">
                            <label>Voting Period (minutes)</label>
                            <input type="number" class="parameter-input" id="voting-period" 
                                   min="5" max="60" value="15">
                            <div class="parameter-value">15 minutes</div>
                        </div>
                        
                        <div class="parameter-control">
                            <label>Performance Period (hours)</label>
                            <input type="number" class="parameter-input" id="performance-period" 
                                   min="1" max="48" value="24">
                            <div class="parameter-value">24 hours</div>
                        </div>
                        
                        <div class="parameter-control">
                            <label>Minimum Bet Amount (SOL)</label>
                            <select class="parameter-input" id="min-bet-amount">
                                <option value="0.05">0.05</option>
                                <option value="0.10" selected>0.10</option>
                                <option value="0.15">0.15</option>
                                <option value="0.20">0.20</option>
                                <option value="0.25">0.25</option>
                                <option value="0.30">0.30</option>
                                <option value="0.35">0.35</option>
                                <option value="0.40">0.40</option>
                                <option value="0.45">0.45</option>
                                <option value="0.50">0.50</option>
                            </select>
                            <div class="parameter-value">
                                <div>0.1 SOL</div>
                                <div>Smart contract range: 0.05-0.5 SOL</div>
                            </div>
                        </div>
                        
                        <div class="parameter-control">
                            <label>Platform Fee (%)</label>
                            <select class="parameter-input" id="platform-fee">
                                <option value="5">5</option>
                                <option value="7.5">7.5</option>
                                <option value="10">10</option>
                                <option value="12.5">12.5</option>
                                <option value="15" selected>15</option>
                                <option value="17.5">17.5</option>
                                <option value="20">20</option>
                                <option value="22.5">22.5</option>
                                <option value="25">25</option>
                            </select>
                            <div class="parameter-value">
                                <div>15%</div>
                                <div>Smart contract range: 5%-25%</div>
                            </div>
                        </div>
                        
                        <div class="parameter-control">
                            <label>Max Pool Size (SOL)</label>
                            <input type="number" class="parameter-input" id="max-pool-size" 
                                   min="10" max="1000" value="100">
                            <div class="parameter-value">100 SOL</div>
                        </div>
                    </div>

                    <div class="cache-controls">
                        <button class="btn btn-primary" onclick="saveAutomationSettings()">
                            üíæ Save Settings
                        </button>
                        <button class="btn btn-secondary" onclick="testAutomationSettings()">
                            üß™ Test Configuration
                        </button>
                        <button class="btn btn-warning" onclick="resetAutomationSettings()">
                            üîÑ Reset to Defaults
                        </button>
                    </div>
                </div>

                <div class="smart-contract-controls">
                    <h4>Smart Contract Operations</h4>
                    <button onclick="startCompetitionWithTwap(competition.competition_id)" class="btn btn-primary">
                        üöÄ Start with TWAP
                    </button>
                    <button onclick="updateCompetitionTwap('COMPETITION_ID')" class="btn btn-secondary">
                        üìä Update TWAP Sample
                    </button>
                </div>

                <!-- Manual Competition Controls -->
                <div class="production-section">
                    <h3>üõ†Ô∏è Manual Competition Controls</h3>
                    <div class="cache-controls">
                        <button id="create-competition-btn" class="btn btn-primary">
                            üöÄ Create New Competition
                        </button>
                        <button class="btn btn-secondary" onclick="refreshCompetitionsList()">
                            üîÑ Refresh List
                        </button>
                        <button class="btn btn-info" onclick="viewCompetitionAnalytics()">
                            üìä View Analytics
                        </button>
                        <button class="btn btn-success" onclick="downloadCompetitionData()">
                            üì• Download Competition Data
                        </button>
                    </div>
                </div>

                <!-- Download Section -->
                <div class="download-section">
                    <h4>üì• Export Options</h4>
                    <div class="cache-controls">
                        <button class="btn btn-info" onclick="downloadActiveCompetitions()">
                            üìÑ Active Competitions (CSV)
                        </button>
                        <button class="btn btn-secondary" onclick="downloadPastCompetitions()">
                            üìö Past Competitions (CSV)
                        </button>
                        <button class="btn btn-primary" onclick="downloadCompetitionReport()">
                            üìä Full Report (JSON)
                        </button>
                    </div>
                </div>

                <!-- Active Competitions -->
                <div class="production-section">
                    <h3>üèÉ Active Competitions</h3>
                    <div class="table-container">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>üÜî ID</th>
                                    <th>ü™ô Tokens</th>
                                    <th>üìä Status</th>
                                    <th>üë• Participants</th>
                                    <th>üí∞ Pool Size</th>
                                    <th>‚è∞ End Time</th>
                                    <th>ü§ñ Type</th>
                                    <th>üõ†Ô∏è Actions</th>
                                </tr>
                            </thead>
                            <tbody id="competitions-tbody">
                                <tr>
                                    <td colspan="8">Loading competitions...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Token Management Section -->
            <section id="tokens" class="admin-section hidden">
                <h2>ü™ô Token Management System</h2>
                
                <!-- Token Statistics -->
                <div class="production-section">
                    <h3>üìä Token Statistics</h3>
                    <div class="cache-health-grid">
                        <div class="cache-health-card">
                            <div class="cache-metric good" id="total-tokens-stat">0</div>
                            <div class="label">Total Tokens</div>
                        </div>
                        <div class="cache-health-card">
                            <div class="cache-metric excellent" id="active-tokens-stat">0</div>
                            <div class="label">Active (Fresh Cache)</div>
                        </div>
                        <div class="cache-health-card">
                            <div class="cache-metric good" id="approved-tokens-stat">0</div>
                            <div class="label">Approved Tokens</div>
                        </div>
                        <div class="cache-health-card">
                            <div class="cache-metric warning" id="blacklisted-tokens-stat">0</div>
                            <div class="label">Blacklisted</div>
                        </div>
                    </div>
                </div>

                <!-- Token Controls -->
                <div class="production-section">
                    <h3>üõ†Ô∏è Token Management Controls</h3>
                    <div class="token-controls">
                        <input type="text" id="token-search" class="token-search" 
                               placeholder="üîç Search tokens by symbol, name, or address...">
                        <button id="refresh-tokens-btn" class="btn btn-primary">
                            üîÑ Refresh Token Cache
                        </button>
                        <button class="btn btn-info" onclick="exportTokenList()">
                            üì§ Export Token List
                        </button>
                    </div>
                    
                    <!-- Token Table -->
                    <div class="table-container" id="tokens-table">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>ü™ô Token</th>
                                    <th>üí∞ Price</th>
                                    <th>üìä Market Cap</th>
                                    <th>üìà 24h Change</th>
                                    <th>‚úÖ Status</th>
                                    <th>üîç Risk Score</th>
                                    <th>üïí Last Updated</th>
                                    <th>üõ†Ô∏è Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tokens-tbody">
                                <tr>
                                    <td colspan="8">Loading tokens...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Analytics Section -->
            <section id="analytics" class="admin-section hidden">
                <h2>üìä Advanced Analytics & Reports</h2>
                
                <!-- Competition Analytics -->
                <div class="production-section">
                    <div class="production-badge">Reports</div>
                    <h3>üèÅ Competition Analytics</h3>
                    <div class="cache-controls">
                        <button class="btn btn-primary" onclick="generateCompetitionReport()">
                            üìä Generate Competition Report
                        </button>
                        <button class="btn btn-secondary" onclick="generateRevenueReport()">
                            üí∞ Platform Revenue Report
                        </button>
                        <button class="btn btn-info" onclick="generateParticipationReport()">
                            üë• User Participation Report
                        </button>
                    </div>
                </div>

                <!-- User Analytics -->
                <div class="production-section">
                    <h3>üë• User Activity Analytics</h3>
                    <div class="cache-controls">
                        <button class="btn btn-primary" onclick="generateUserReport()">
                            üìà User Activity Report
                        </button>
                        <button class="btn btn-secondary" onclick="generateEngagementReport()">
                            üéØ Engagement Analytics
                        </button>
                        <button class="btn btn-info" onclick="generateRetentionReport()">
                            üîÑ User Retention Report
                        </button>
                    </div>
                </div>

                <!-- System Analytics -->
                <div class="production-section">
                    <h3>‚öôÔ∏è System Performance</h3>
                    <div class="performance-chart">
                        <canvas id="system-performance-chart"></canvas>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Blockchain dependencies loaded with proper sequencing -->
    <script>
    // Wait for blockchain dependencies before loading admin scripts
    window.addEventListener('load', function() {
        console.log('üöÄ [ADMIN] Loading admin scripts with blockchain support...');
        
        // Load scripts in proper order
        const adminScripts = [
            '../config.js',                    // Configuration first
            '../supabase-client.js',           // Database client
            '../wallet-service.js',            // Wallet integration
            '../smart-contract-service.js',    // Blockchain service
            'auth.js',                         // Admin authentication
            'components/cache-monitor.js',     // Admin components
            'components/token-approval.js',
            'components/blacklist-manager.js',
            'components/pair-optimizer.js', 
            'admin.js'                         // Main admin logic last
        ];
        
        loadAdminScriptsSequentially(adminScripts);
    });
    
    function loadAdminScriptsSequentially(scripts) {
        if (scripts.length === 0) {
            console.log('‚úÖ [ADMIN] All admin scripts loaded with blockchain support');
            // Initialize blockchain services after all scripts loaded
            initializeAdminBlockchainServices();
            return;
        }
        
        const script = scripts.shift();
        const scriptElement = document.createElement('script');
        scriptElement.src = script;
        
        scriptElement.onload = function() {
            console.log(`‚úÖ [ADMIN] Loaded: ${script}`);
            loadAdminScriptsSequentially(scripts);
        };
        
        scriptElement.onerror = function() {
            console.error(`‚ùå [ADMIN] Failed to load: ${script}`);
            loadAdminScriptsSequentially(scripts); // Continue anyway
        };
        
        document.head.appendChild(scriptElement);
    }
    
    // Initialize blockchain services for admin
    async function initializeAdminBlockchainServices() {
        try {
            console.log('üîó [ADMIN] Initializing blockchain services...');
            
            // Initialize smart contract service
            if (window.SmartContractService) {
                window.adminSmartContractService = new SmartContractService();
                const success = await window.adminSmartContractService.initialize();
                
                window.adminBlockchainReady = success;
                console.log(success ? '‚úÖ [ADMIN] Blockchain services ready' : '‚ö†Ô∏è [ADMIN] Blockchain services unavailable');
            } else {
                window.adminBlockchainReady = false;
                console.log('‚ö†Ô∏è [ADMIN] Smart contract service not available');
            }
            
            // Update admin UI to show blockchain status
            if (typeof updateAdminBlockchainStatus === 'function') {
                updateAdminBlockchainStatus();
            }
            
            // Initialize admin panel after blockchain setup
            initializeAdminPanelAfterBlockchain();
            
        } catch (error) {
            console.error('‚ùå [ADMIN] Blockchain initialization failed:', error);
            window.adminBlockchainReady = false;
            if (typeof updateAdminBlockchainStatus === 'function') {
                updateAdminBlockchainStatus();
            }
            // Still initialize admin panel even if blockchain fails
            initializeAdminPanelAfterBlockchain();
        }
    }

    // Admin panel initialization (proper authentication flow)
    function initializeAdminPanelAfterBlockchain() {
        console.log('üîó [ADMIN] Blockchain services initialized, waiting for authentication...');
        
        // Don't auto-show admin panel - let auth.js handle this
        // The auth.js module will call showAdminPanel() after proper authentication
        
        // Just ensure we're ready to initialize when auth completes
        window.adminPanelReady = true;
        
        console.log('‚úÖ [ADMIN] Ready for authentication');
    }

    // DOM ready listener to start the process
    document.addEventListener('DOMContentLoaded', () => {
        // The blockchain loading process will handle admin panel initialization
        console.log('üìã [ADMIN] DOM ready, blockchain initialization will handle the rest');
    });

        // Quick Action Functions
        function quickCacheRefresh() {
            console.log('üîÑ Quick cache refresh triggered');
            showAdminNotification('Cache refresh initiated', 'info');
        }
        
        function viewPendingApprovals() {
            switchToSection('token-approval');
        }
        
        function reviewBlacklist() {
            switchToSection('blacklist-management');
        }
        
        function viewPairAnalytics() {
            switchToSection('pair-optimization');
        }

        // Competition Automation Functions
        function startCompetitionAutomation() {
            if (!verifyAdminWallet()) return;
            
            if (confirm('üöÄ Start automated competition generation? This will create competitions based on configured parameters.')) {
                console.log('‚ñ∂Ô∏è Starting competition automation...');
                showAdminNotification('Competition automation started', 'success');
                // Implementation will be added in admin.js
            }
        }
        
        function stopCompetitionAutomation() {
            if (!verifyAdminWallet()) return;
            
            if (confirm('‚èπÔ∏è Stop automated competition generation? This will halt all automatic competition creation.')) {
                console.log('‚èπÔ∏è Stopping competition automation...');
                showAdminNotification('Competition automation stopped', 'warning');
                // Implementation will be added in admin.js
            }
        }
        
        function verifyAdminWallet() {
            const adminWallet = sessionStorage.getItem('adminWallet');
            if (!adminWallet) {
                showAdminNotification('Admin wallet not connected', 'error');
                return false;
            }
            // Database verification will be implemented in admin.js
            return true;
        }
        
        function saveAutomationSettings() {
            console.log('üíæ Saving automation settings...');
            showAdminNotification('Automation settings saved', 'success');
        }
        
        function testAutomationSettings() {
            console.log('üß™ Testing automation configuration...');
            showAdminNotification('Configuration test passed', 'success');
        }
        
        function resetAutomationSettings() {
            if (confirm('üîÑ Reset automation settings to defaults?')) {
                console.log('üîÑ Resetting automation settings...');
                showAdminNotification('Settings reset to defaults', 'warning');
            }
        }

        // Download Functions
        function downloadActiveCompetitions() {
            console.log('üìÑ Downloading active competitions...');
            showAdminNotification('Preparing download...', 'info');
        }
        
        function downloadPastCompetitions() {
            console.log('üìö Downloading past competitions...');
            showAdminNotification('Preparing download...', 'info');
        }
        
        function downloadCompetitionReport() {
            console.log('üìä Generating full competition report...');
            showAdminNotification('Generating report...', 'info');
        }

        // Analytics Functions
        function generateCompetitionReport() {
            console.log('üìä Generating competition analytics report...');
            showAdminNotification('Report generation started', 'info');
        }
        
        function generateUserReport() {
            console.log('üë• Generating user activity report...');
            showAdminNotification('User report generation started', 'info');
        }

        function generateRevenueReport() {
            console.log('üí∞ Generating revenue report...');
            showAdminNotification('Revenue report generation started', 'info');
        }
        
        function generateParticipationReport() {
            console.log('üë• Generating participation report...');
            showAdminNotification('Participation report generation started', 'info');
        }
        
        function generateEngagementReport() {
            console.log('üéØ Generating engagement report...');
            showAdminNotification('Engagement report generation started', 'info');
        }
        
        function generateRetentionReport() {
            console.log('üîÑ Generating retention report...');
            showAdminNotification('Retention report generation started', 'info');
        }

        // Cache Functions
        function refreshTokenCache() {
            console.log('ü™ô Refreshing token cache...');
            showAdminNotification('Token cache refresh initiated', 'info');
        }
        
        function viewCacheAnalytics() {
            console.log('üìä Viewing cache analytics...');
            showAdminNotification('Loading cache analytics...', 'info');
        }

        // Blacklist Functions
        function whitelistWithApproval() {
            console.log('üîÑ Whitelist with approval...');
            showAdminNotification('Whitelist to approval queue feature coming soon', 'info');
        }
        
        function exportBlacklist() {
            console.log('üì§ Exporting blacklist...');
            showAdminNotification('Blacklist export feature coming soon', 'info');
        }
        
        function scanForThreats() {
            console.log('üîç Scanning for threats...');
            showAdminNotification('Threat scanning feature coming soon', 'info');
        }

        // Token Management Functions
        function exportTokenList() {
            console.log('üì§ Exporting token list...');
            showAdminNotification('Token list export feature coming soon', 'info');
        }
        
        function viewTokenAnalytics() {
            console.log('üìä Viewing token analytics...');
            showAdminNotification('Token analytics feature coming soon', 'info');
        }

        // Competition Functions
        function refreshCompetitionsList() {
            console.log('üîÑ Refreshing competitions list...');
            showAdminNotification('Competitions list refreshed', 'info');
        }
        
        function viewCompetitionAnalytics() {
            console.log('üìä Viewing competition analytics...');
            showAdminNotification('Competition analytics feature coming soon', 'info');
        }
        
        function downloadCompetitionData() {
            console.log('üì• Downloading competition data...');
            showAdminNotification('Competition data download feature coming soon', 'info');
        }

        // Navigation Functions
        function switchToSection(sectionName) {
            console.log('üß≠ Switching to section:', sectionName);
            
            // Hide all sections
            document.querySelectorAll('.admin-section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Show target section
            const targetSection = document.getElementById(sectionName);
            if (targetSection) {
                targetSection.classList.remove('hidden');
            }
            
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            const targetNavItem = document.querySelector(`[href="#${sectionName}"]`);
            if (targetNavItem) {
                targetNavItem.classList.add('active');
            }
        }

        // Utility function for notifications
        function showAdminNotification(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);
            
            const notification = document.createElement('div');
            notification.className = `admin-notification ${type}`;
            notification.innerHTML = `
                <span>${message}</span>
                <button onclick="this.parentElement.remove()">&times;</button>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        console.log('‚úÖ Production Admin Panel HTML loaded');
        console.log('üöÄ Features:');
        console.log('   üîß Live cache management');
        console.log('   ‚úÖ Manual token approval workflow');
        console.log('   üö´ Blacklist management with whitelist');
        console.log('   üìà Pair analytics dashboard');
        console.log('   ü§ñ Competition automation system');
        console.log('   üìä Advanced analytics and reporting');

// DIRECT DEBUG: Force authentication setup
    function forceAuthSetup() {
        console.log('üîß [FORCE] Setting up authentication directly...');
        
        // Check if elements exist
        const connectBtn = document.getElementById('connect-admin-wallet');
        const pinInput = document.getElementById('admin-pin');
        const verifyBtn = document.getElementById('verify-pin');
        
        console.log('üîç [FORCE] Elements check:');
        console.log('   - Connect button:', !!connectBtn);
        console.log('   - PIN input:', !!pinInput);
        console.log('   - Verify button:', !!verifyBtn);
        console.log('   - window.solana:', !!window.solana);
        
        if (connectBtn) {
            console.log('üîó [FORCE] Adding click listener to connect button...');
            
            // Remove existing listeners and add new one
            connectBtn.onclick = function() {
                console.log('üîò [FORCE] Connect wallet clicked!');
                forceConnectWallet();
            };
            
            // Also try addEventListener
            connectBtn.addEventListener('click', function(e) {
                console.log('üîò [EVENT] Connect wallet clicked via addEventListener!');
                e.preventDefault();
                forceConnectWallet();
            });
            
            console.log('‚úÖ [FORCE] Listeners added to connect button');
        } else {
            console.error('‚ùå [FORCE] Connect button not found!');
        }
    }
    
    // Direct wallet connection function
    async function forceConnectWallet() {
        try {
            console.log('üöÄ [FORCE] Starting wallet connection...');
            
            // Check for Phantom wallet
            if (!window.solana) {
                console.error('‚ùå [FORCE] window.solana not available');
                alert('Please install Phantom wallet to access admin panel');
                return;
            }
            
            console.log('‚úÖ [FORCE] window.solana available');
            
            // Request connection
            const response = await window.solana.connect();
            const publicKey = response.publicKey.toString();
            
            console.log('‚úÖ [FORCE] Wallet connected:', publicKey);
            
            // Update UI manually
            const connectBtn = document.getElementById('connect-admin-wallet');
            const walletStatus = document.getElementById('wallet-status');
            const walletAddress = document.querySelector('.wallet-address');
            const pinStep = document.getElementById('step-pin');
            const pinInput = document.getElementById('admin-pin');
            const verifyBtn = document.getElementById('verify-pin');
            
            if (connectBtn) connectBtn.style.display = 'none';
            if (walletStatus) walletStatus.classList.remove('hidden');
            if (walletAddress) walletAddress.textContent = publicKey.substring(0, 6) + '...' + publicKey.substring(publicKey.length - 4);
            
            // Enable PIN step
            if (pinStep) pinStep.classList.remove('disabled');
            if (pinInput) {
                pinInput.disabled = false;
                pinInput.focus();
            }
            if (verifyBtn) verifyBtn.disabled = false;
            
            // Store wallet info
            sessionStorage.setItem('adminWallet', publicKey);
            
            console.log('‚úÖ [FORCE] UI updated, PIN step enabled');
            
            // Add PIN verification listener
            if (verifyBtn) {
                verifyBtn.onclick = function() {
                    console.log('üîò [FORCE] Verify PIN clicked!');
                    forceVerifyPin(publicKey);
                };
            }
            
        } catch (error) {
            console.error('‚ùå [FORCE] Wallet connection failed:', error);
            alert('Failed to connect wallet: ' + error.message);
        }
    }
    
    // Direct PIN verification
    async function forceVerifyPin(walletAddress) {
        try {
            const pinInput = document.getElementById('admin-pin');
            const pin = pinInput ? pinInput.value : '';
            
            console.log('üîê [FORCE] Verifying PIN...', { pin: pin.length, wallet: walletAddress });
            
            if (!pin || pin.length !== 6) {
                alert('Please enter a 6-digit PIN');
                return;
            }
            
            // Make API request
            const apiUrl = `${window.location.origin}/api/admin/auth/verify`;
            console.log('üì° [FORCE] Calling API:', apiUrl);
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ walletAddress, pin })
            });
            
            const data = await response.json();
            console.log('üì° [FORCE] API response:', data);
            
            if (response.ok && data.success) {
                console.log('‚úÖ [FORCE] Authentication successful!');
                
                // Store token
                sessionStorage.setItem('adminToken', data.token);
                
                // Show admin panel
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
                
                console.log('‚úÖ [FORCE] Admin panel shown');
                
                // Initialize admin panel properly
                setTimeout(() => {
                    console.log('üîß [FORCE] Initializing admin panel...');
                    
                    if (window.initializeAdminPanel) {
                        window.initializeAdminPanel().then(() => {
                            console.log('‚úÖ [FORCE] Admin panel initialized successfully');
                        }).catch(error => {
                            console.error('‚ùå [FORCE] Admin panel initialization failed:', error);
                        });
                    } else {
                        console.error('‚ùå [FORCE] initializeAdminPanel function not available');
                        console.log('üîç Available functions:', Object.keys(window).filter(k => k.includes('admin')));
                    }
                    
                    // Also update blockchain status
                    if (typeof updateAdminBlockchainStatus === 'function') {
                        updateAdminBlockchainStatus();
                    }
                    
                }, 1000);
                
            } else {
                console.error('‚ùå [FORCE] Authentication failed:', data.message);
                alert('Authentication failed: ' + (data.message || 'Invalid credentials'));
            }
            
        } catch (error) {
            console.error('‚ùå [FORCE] PIN verification error:', error);
            alert('PIN verification failed: ' + error.message);
        }
    }
    
// Debug section switching
    function debugSectionSwitching() {
        console.log('üîç [DEBUG] Testing section switching...');
        
        // Check if navigation elements exist
        const navItems = document.querySelectorAll('.nav-item');
        const sections = document.querySelectorAll('.admin-section');
        
        console.log('üîç [DEBUG] Found:', {
            navItems: navItems.length,
            sections: sections.length
        });
        
        // Add click listeners to nav items
        navItems.forEach((item, index) => {
            console.log(`üîó [DEBUG] Adding listener to nav item ${index}:`, item.textContent);
            
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const href = item.getAttribute('href');
                const sectionName = href ? href.substring(1) : 'dashboard';
                
                console.log(`üîò [DEBUG] Nav item clicked: ${sectionName}`);
                
                // Manual section switching
                sections.forEach(section => {
                    section.classList.add('hidden');
                });
                
                const targetSection = document.getElementById(sectionName);
                if (targetSection) {
                    targetSection.classList.remove('hidden');
                    console.log(`‚úÖ [DEBUG] Switched to section: ${sectionName}`);
                } else {
                    console.error(`‚ùå [DEBUG] Section not found: ${sectionName}`);
                }
                
                // Update active nav
                navItems.forEach(nav => nav.classList.remove('active'));
                item.classList.add('active');
            });
        });
    }
    
// Debug database connection
    async function debugDatabaseConnection() {
        console.log('üîç [DEBUG] Testing database connection...');
        
        try {
            if (window.supabase) {
                console.log('‚úÖ [DEBUG] Supabase client available');
                
                // Test a simple query
                const { data, error } = await window.supabase
                    .from('users')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    console.error('‚ùå [DEBUG] Database query failed:', error);
                } else {
                    console.log('‚úÖ [DEBUG] Database query successful:', data);
                }
                
            } else {
                console.error('‚ùå [DEBUG] Supabase client not available');
            }
        } catch (error) {
            console.error('‚ùå [DEBUG] Database test error:', error);
        }
    }
    
    // Test database after authentication
    setTimeout(debugDatabaseConnection, 4000);

    // Call debug function after admin panel is shown
    setTimeout(debugSectionSwitching, 3000);

    // Force setup after everything loads
    setTimeout(forceAuthSetup, 2000);
    
    // Also try on window load
    window.addEventListener('load', () => {
        setTimeout(forceAuthSetup, 1000);
    });

    </script>
    <!-- Emergency Cleanup Modal -->
    <div id="emergencyCleanupModal" class="modal" style="display: none;">
        <div class="modal-content">
            <button class="close-modal" onclick="closeEmergencyCleanupModal()">&times;</button>
            
            <div style="text-align: center; margin-bottom: 2rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üö®</div>
                <h2 style="color: var(--admin-error); margin: 0;">Emergency Cleanup Confirmation</h2>
            </div>
            
            <div class="security-warning">
                <h4 style="margin: 0 0 1rem 0; color: var(--admin-warning);">‚ö†Ô∏è WARNING: This action cannot be undone!</h4>
                <p style="margin: 0;">Emergency cleanup will:</p>
                <ul style="margin: 0.5rem 0 0 1rem;">
                    <li>Cancel the competition immediately</li>
                    <li>Users can withdraw their original bets</li>
                </ul>
            </div>
            
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--admin-text);">
                    Type the competition ID to confirm:
                </label>
                <input 
                    type="text" 
                    id="confirmCompetitionId" 
                    placeholder="Enter competition ID" 
                    style="
                        width: 100%;
                        padding: 0.75rem;
                        background: var(--admin-bg);
                        border: 1px solid var(--admin-border);
                        border-radius: 6px;
                        color: var(--admin-text);
                        font-family: monospace;
                    "
                />
                <div style="margin-top: 0.5rem; padding: 0.5rem; background: var(--admin-surface); border-radius: 4px; border: 1px solid var(--admin-border);">
                    <strong>Competition ID:</strong> <span id="targetCompetitionId" style="font-family: monospace; color: var(--admin-primary);"></span>
                </div>
            </div>
            
            <div style="display: flex; justify-content: space-between; gap: 1rem;">
                <button 
                    class="btn btn-secondary" 
                    onclick="closeEmergencyCleanupModal()"
                    style="flex: 1;"
                >
                    Cancel
                </button>
                <button 
                    class="btn btn-danger" 
                    onclick="executeEmergencyCleanup()" 
                    id="confirmCleanupBtn" 
                    disabled
                    style="flex: 1;"
                >
                    üö® Confirm Emergency Cleanup
                </button>
            </div>
        </div>
    </div>
</body>
</html>
