<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TokenWars - Predict. Compete. Profit.</title>
    <meta name="description" content="TokenWars - Solana token prediction competitions. Predict token performance, compete with others, earn SOL rewards.">
    <meta property="og:title" content="TokenWars - Predict. Compete. Profit.">
    <meta property="og:description" content="Predict token performance, compete with others, earn SOL rewards">
    <meta property="og:type" content="website">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="icon" type="image/png" href="favicon.png">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- Supabase Client -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- Solana Web3.js -->
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    
    <!-- Chart.js for price charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Database Connection Status -->
    <div id="dbStatus" class="db-status disconnected">
        Database: Connecting...
    </div>

    <!-- Token Update Status -->
    <div id="tokenStatus" class="db-status disconnected" style="top: 3rem;">
        Tokens: Loading...
    </div>

    <!-- Animated Background -->
    <div class="animated-background"></div>
    <div class="geometric-patterns"></div>

    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="#home" class="logo" onclick="showPage('home'); return false;">TokenWars</a>
            
            <ul class="nav-links">
                <li><a href="#home" class="nav-link active" data-page="home" onclick="showPage('home'); return false;">Home</a></li>
                <li><a href="#competitions" class="nav-link" data-page="competitions" onclick="showPage('competitions'); return false;">Competitions</a></li>
                <li><a href="#leaderboard" class="nav-link" data-page="leaderboard" onclick="showPage('leaderboard'); return false;">Leaderboard</a></li>
                <li><a href="#portfolio" class="nav-link" data-page="portfolio" onclick="showPage('portfolio'); return false;">Portfolio</a></li>
                <li><a href="how-it-works.html" class="nav-link" target="_blank">Platform Guide</a></li>
                
                <!-- Disconnected State -->
                <li id="connectWalletBtn"><a href="#" class="btn-primary wallet-connect-btn">Connect Wallet</a></li>
                
                <!-- Connected State (Hidden by default) -->
                <li id="traderInfo" style="display: none;">
                    <div class="trader-info-display">
                        <div id="navTraderAvatar" class="trader-avatar">üéØ</div>
                        <div class="trader-details">
                            <span id="navTraderName" class="trader-name">Trader</span>
                            <span id="navTraderBalance" class="trader-balance">0.00 SOL</span>
                        </div>
                        <button class="nav-disconnect" onclick="disconnectWallet()" title="Disconnect Wallet">‚èª</button>
                    </div>
                </li>
            </ul>

            <!-- Mobile Menu Toggle -->
            <button class="mobile-menu-toggle" aria-label="Toggle mobile menu" aria-expanded="false">
                <div class="hamburger">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </button>
        </div>
    </nav>

    <!-- PAGE CONTAINER -->
    <div id="pageContainer" class="page-container">
        
        <!-- HOME PAGE -->
        <div id="homePage" class="page-content active">
            <!-- Hero Section -->
            <div class="hero">
                <div class="hero-content">
                    <!-- Disconnected State Hero -->
                    <div id="heroDisconnected">
                        <h1 class="hero-title">TokenWars</h1>
                        <p class="hero-motto">PREDICT. COMPETE. PROFIT.</p>
                        <div class="cta-buttons">
                            <a href="#" class="btn-hero-primary wallet-connect-btn">Connect Wallet</a>
                            <a href="#" class="btn-secondary" onclick="scrollToLearnMore(); return false;">Learn More</a>
                        </div>
                    </div>

                    <!-- Connected State Hero -->
                    <div id="heroConnected" style="display: none;">
                        <h1 class="hero-title">TokenWars</h1>
                        <p class="hero-motto">PREDICT. COMPETE. PROFIT.</p>
                        
                        <div class="trader-welcome-enhanced">
                            <div class="welcome-message">
                                <p class="welcome-trader">Welcome back, <span class="trader-name-highlight" id="heroTraderNameText">Trader</span>!</p>
                            </div>
                        </div>
                        
                        <div class="cta-buttons">
                            <a href="#competitions" class="btn-hero-primary" onclick="showPage('competitions'); return false;">View Competitions</a>
                            <a href="#" class="btn-secondary" onclick="scrollToLearnMore(); return false;">Learn More</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Learn More Section -->
            <div class="learn-more-section" id="learnMoreSection">
                <div class="container">
                    <div class="section-header">
                        <h2 class="section-title">How TokenWars Works</h2>
                        <p class="section-description">Simple, fair, and transparent token prediction competitions</p>
                    </div>

                    <div class="info-cards-grid">
                        <div class="info-card">
                            <div class="card-icon">üìä</div>
                            <h3>Simple Predictions</h3>
                            <p>Pick which tokens will outperform over the competition period. Entry opens before each competition starts.</p>
                        </div>
                        <div class="info-card">
                            <div class="card-icon">üí∞</div>
                            <h3>Fixed Stakes</h3>
                            <p>0.1 SOL entry fee. Winners split the pool (minus 15% platform fee). Fair and transparent.</p>
                        </div>
                        <div class="info-card">
                            <div class="card-icon">üîê</div>
                            <h3>Automated Payouts</h3>
                            <p>Smart contracts handle everything. Escrow opens, competition runs, winners get paid automatically.</p>
                        </div>
                    </div>

                    <div class="detailed-guide-cta">
                        <h3>Want More Details?</h3>
                        <p>Check out our comprehensive guide covering competition phases, smart contracts, and winning strategies.</p>
                        <a href="how-it-works.html" class="btn-hero-primary" target="_blank">
                            üìñ Complete Platform Guide ‚Üí
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- COMPETITIONS PAGE - Database-Centric Implementation -->
        <div id="competitionsPage" class="page-content">
            <div class="main-content">
                <!-- Disconnected User View -->
                <div id="competitionsDisconnected">
                    <section class="section">
                        <div class="container">
                            <div class="section-header">
                                <h2 class="section-title">COMPETITIONS</h2>
                                <p class="section-description">Connect your wallet to participate in token prediction competitions</p>
                            </div>
                            
                            <div class="competitions-grid">
                                <div class="empty-competitions">
                                    <div class="empty-icon">üîó</div>
                                    <h3>Connect Wallet to Join Competitions</h3>
                                    <p>Connect your wallet to participate in token prediction competitions and earn SOL rewards.</p>
                                    <button class="btn-primary wallet-connect-btn">Connect Wallet</button>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>

                <!-- Connected User View - Database-Driven -->
                <div id="competitionsConnected" style="display: none;">
                    <section class="section">
                        <div class="container">
                            <div class="section-header">
                                <h2 class="section-title">COMPETITIONS</h2>
                                <p class="section-description">Predict token performance and earn SOL rewards</p>
                                <div class="section-filters">
                                    <select id="competition-phase" class="filter-select" onchange="handleCompetitionFilterChange()">
                                        <option value="all">All Phases</option>
                                        <option value="voting">Voting Open</option>
                                        <option value="active">Running</option>
                                        <option value="completed">Completed</option>
                                    </select>
                                    <select id="sort-by" class="filter-select" onchange="handleCompetitionFilterChange()">
                                        <option value="start_time">Start Time</option>
                                        <option value="total_pool">Pool Size</option>
                                        <option value="total_bets">Participants</option>
                                    </select>
                                    <button class="btn-refresh" onclick="refreshCompetitions()">
                                        <span class="refresh-icon">üîÑ</span> Refresh
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Competitions Container -->
                            <div class="competitions-container">
                                <div class="competitions-grid" id="competitionsGrid">
                                    <div class="loading-state">
                                        <div class="loading-spinner"></div>
                                        <p>Loading competitions from database...</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Competition Stats Summary -->
                            <div class="competition-stats-summary" style="margin-top: 3rem;">
                                <div class="stats-grid">
                                    <div class="stat-card">
                                        <div class="stat-icon">üèÜ</div>
                                        <div class="stat-content">
                                            <div class="stat-value" id="totalCompetitions">0</div>
                                            <div class="stat-label">Total Competitions</div>
                                        </div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-icon">üë•</div>
                                        <div class="stat-content">
                                            <div class="stat-value" id="totalParticipants">0</div>
                                            <div class="stat-label">Total Participants</div>
                                        </div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-icon">üí∞</div>
                                        <div class="stat-content">
                                            <div class="stat-value" id="totalPrizePool">0.0 SOL</div>
                                            <div class="stat-label">Total Prize Pool</div>
                                        </div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-icon">‚ö°</div>
                                        <div class="stat-content">
                                            <div class="stat-value" id="activeCompetitions">0</div>
                                            <div class="stat-label">Active Now</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </div>
        
        <!-- LEADERBOARD PAGE -->
        <div id="leaderboardPage" class="page-content">
            <div class="main-content">
                <section class="section">
                    <div class="container">
                        <div class="section-header">
                            <h2 class="section-title">LEADERBOARD</h2>
                            <div class="section-filters">
                                <select id="leaderboard-period" class="filter-select" onchange="handleLeaderboardFilterChange()">
                                    <option value="all-time">All Time</option>
                                    <option value="monthly">This Month</option>
                                    <option value="weekly">This Week</option>
                                </select>
                                <select id="leaderboard-sort" class="filter-select" onchange="handleLeaderboardFilterChange()">
                                    <option value="total_winnings">Total Winnings</option>
                                    <option value="win_rate">Win Rate</option>
                                    <option value="current_streak">Current Streak</option>
                                    <option value="total_bets">Total Competitions</option>
                                </select>
                                <button class="btn-refresh" onclick="refreshLeaderboard()">
                                    <span class="refresh-icon">üîÑ</span> Refresh
                                </button>
                            </div>
                        </div>

                        <!-- Leaderboard Content -->
                        <div id="leaderboard-content">
                            <div class="leaderboard-table-container">
                                <div class="leaderboard-table" id="leaderboardTable">
                                    <div class="loading-state">
                                        <div class="loading-spinner"></div>
                                        <p>Loading leaderboard from database...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>

        <!-- PORTFOLIO PAGE -->
        <div id="portfolioPage" class="page-content">
            <div class="main-content">
                <section class="section">
                    <div class="container">
                        <div class="section-header">
                            <h2 class="section-title">MY PORTFOLIO</h2>
                            <div class="section-filters">
                                <select id="portfolio-view" class="filter-select" onchange="handlePortfolioViewChange()">
                                    <option value="overview">Overview</option>
                                    <option value="history">Betting History</option>
                                    <option value="statistics">Statistics</option>
                                </select>
                                <button class="btn-refresh" onclick="refreshPortfolioData()">
                                    <span class="refresh-icon">üîÑ</span> Refresh
                                </button>
                            </div>
                        </div>

                        <!-- Portfolio Content Container -->
                        <div id="portfolio-content">
                            <div class="loading-state">
                                <div class="loading-spinner"></div>
                                <p>Loading your portfolio...</p>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- Competition Details Modal -->
    <div class="competition-modal" id="competitionModal" style="display: none;">
        <div class="competition-modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Competition Details</h3>
                <button class="modal-close" onclick="closeCompetitionModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="modal-tokens-section">
                    <div class="modal-token-card">
                        <img id="modalTokenALogo" class="modal-token-logo" src="" alt="">
                        <div class="token-symbol" id="modalTokenASymbol">SOL</div>
                        <div class="token-name" id="modalTokenAName">Solana</div>
                        <div class="token-price" id="modalTokenAPrice">$0.00</div>
                        <div class="price-change" id="modalTokenAChange">+0.00%</div>
                    </div>
                    <div class="modal-vs">VS</div>
                    <div class="modal-token-card">
                        <img id="modalTokenBLogo" class="modal-token-logo" src="" alt="">
                        <div class="token-symbol" id="modalTokenBSymbol">USDC</div>
                        <div class="token-name" id="modalTokenBName">USD Coin</div>
                        <div class="token-price" id="modalTokenBPrice">$0.00</div>
                        <div class="price-change" id="modalTokenBChange">+0.00%</div>
                    </div>
                </div>

                <div class="competition-stats" id="modalStats">
                    <div class="stat-item">
                        <div class="stat-value" id="modalParticipants">0</div>
                        <div class="stat-label">Participants</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="modalPrizePool">0.0 SOL</div>
                        <div class="stat-label">Prize Pool</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="modalTimeRemaining">--</div>
                        <div class="stat-label">Time Remaining</div>
                    </div>
                </div>

                <div class="betting-interface" id="bettingInterface">
                    <h4 class="betting-title">Place Your Prediction</h4>
                    
                    <div class="token-choice-buttons">
                        <button class="token-choice-button" id="choiceTokenA" onclick="selectToken('A')">
                            <div class="token-symbol" id="choiceTokenASymbol">SOL</div>
                            <div class="bet-button-label">I predict this wins</div>
                        </button>
                        <button class="token-choice-button" id="choiceTokenB" onclick="selectToken('B')">
                            <div class="token-symbol" id="choiceTokenBSymbol">USDC</div>
                            <div class="bet-button-label">I predict this wins</div>
                        </button>
                    </div>

                    <div class="bet-amount-section">
                        <label for="betAmount" style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">
                            Bet Amount (SOL)
                        </label>
                        <input 
                            type="number" 
                            id="betAmount" 
                            class="bet-amount-input" 
                            value="0.1" 
                            min="0.1" 
                            step="0.1"
                            placeholder="0.1"
                        >
                    </div>

                    <button class="place-bet-button" id="placeBetButton" onclick="placeBet()" disabled>
                        Select a token to continue
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Wallet Connection Modal -->
    <div class="wallet-modal" id="walletModal" style="display: none;">
        <div class="wallet-modal-content">
            <div class="modal-header">
                <button class="modal-close" onclick="closeWalletModal()">√ó</button>
                <div class="modal-title" id="modalTitle">Connect Wallet</div>
                <div class="modal-subtitle" id="modalSubtitle">Choose your preferred Solana wallet to get started</div>
            </div>

            <!-- Step Indicators -->
            <div class="step-indicators">
                <div class="step-indicator active" id="step1Indicator">1</div>
                <div class="step-indicator" id="step2Indicator">2</div>
                <div class="step-indicator" id="step3Indicator">3</div>
                <div class="step-indicator" id="step4Indicator">4</div>
            </div>

            <!-- Step 1: Wallet Selection -->
            <div class="step-content active" id="step1Content">
                <div class="security-info">
                    <div class="security-title">üîí Security First</div>
                    <div class="security-text">
                        TokenWars connects to your wallet securely to track your predictions. We never access your private keys or make unauthorized transactions.
                    </div>
                </div>

                <div class="wallet-options">
                    <div class="wallet-option" data-wallet="phantom">
                        <div class="wallet-icon">üëª</div>
                        <div class="wallet-info">
                            <div class="wallet-name">Phantom</div>
                            <div class="wallet-description">Most popular Solana wallet</div>
                            <div class="wallet-status" id="phantomStatus">Checking...</div>
                        </div>
                    </div>

                    <div class="wallet-option" data-wallet="solflare">
                        <div class="wallet-icon">‚òÄÔ∏è</div>
                        <div class="wallet-info">
                            <div class="wallet-name">Solflare</div>
                            <div class="wallet-description">Secure and feature-rich</div>
                            <div class="wallet-status" id="solflareStatus">Checking...</div>
                        </div>
                    </div>

                    <div class="wallet-option" data-wallet="backpack">
                        <div class="wallet-icon">üéí</div>
                        <div class="wallet-info">
                            <div class="wallet-name">Backpack</div>
                            <div class="wallet-description">Modern crypto wallet</div>
                            <div class="wallet-status" id="backpackStatus">Checking...</div>
                        </div>
                    </div>

                    <div class="wallet-option demo-wallet" data-wallet="demo">
                        <div class="wallet-icon">üéÆ</div>
                        <div class="wallet-info">
                            <div class="wallet-name">Demo Mode</div>
                            <div class="wallet-description">Try without wallet (10 SOL)</div>
                            <div class="wallet-status" id="demoStatus">‚úì Available</div>
                        </div>
                    </div>
                </div>

                <div class="modal-actions">
                    <button class="btn-modal-secondary" onclick="closeWalletModal()">Cancel</button>
                </div>
            </div>

            <!-- Additional wallet modal steps... -->
            <!-- (Keeping existing step 2, 3, 4 content for brevity) -->
        </div>
    </div>

    <!-- Configuration Script -->
    <script>
        window.SUPABASE_CONFIG = {
            url: 'https://lavbfujrqmxiyfkfgcqy.supabase.co',
            anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxhdmJmdWpycW14aXlma2ZnY3F5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3NjYwNjIsImV4cCI6MjA2NjM0MjA2Mn0.hlDZzchNyhcEX4KW5YNXwcaq3WYDWkc7IeSdflmAYbs'
        };
        
        console.log('‚úÖ Configuration loaded');
    </script>
    
    <!-- Core application files in database-centric order -->
    <script src="config.js"></script>
    <script src="supabase-client.js"></script>
    <script src="utils.js"></script>
    <script src="wallet-service.js"></script>
    <!-- ‚ùå REMOVED: competition-manager.js -->
    <script src="competition.js"></script>
    <script src="app.js"></script>
    
    <!-- Database-Centric Application Logic -->
    <script>
        // =============================================
        // DATABASE-CENTRIC TOKENWARS APPLICATION
        // =============================================

        console.log('üóÑÔ∏è Starting Database-Centric TokenWars Application...');

        // Global state for database-driven app
        let globalState = {
            supabase: null,
            isConnected: false,
            currentUser: null,
            competitions: [],
            users: [],
            currentPage: 'home',
            filters: {
                phase: 'all',
                sortBy: 'start_time'
            }
        };

        // =============================================
        // DATABASE CONNECTION & INITIALIZATION
        // =============================================

        async function initializeDatabaseApp() {
            try {
                console.log('üöÄ Initializing database-centric application...');
                
                // Initialize Supabase connection
                await initializeSupabaseConnection();
                
                // Set up page navigation
                initializeNavigation();
                
                // Set up wallet connection handlers
                setupWalletHandlers();
                
                // Update UI based on initial state
                updateUIForConnectionState();
                
                console.log('‚úÖ Database-centric application initialized successfully');
                
            } catch (error) {
                console.error('‚ùå Failed to initialize application:', error);
                showNotification('Failed to initialize application', 'error');
            }
        }

        async function initializeSupabaseConnection() {
            try {
                if (window.supabaseClient && typeof window.supabaseClient.initializeSupabase === 'function') {
                    globalState.supabase = await window.supabaseClient.initializeSupabase();
                    console.log('‚úÖ Supabase connected via supabaseClient');
                } else if (window.SUPABASE_CONFIG) {
                    const { createClient } = supabase;
                    globalState.supabase = createClient(
                        window.SUPABASE_CONFIG.url,
                        window.SUPABASE_CONFIG.anonKey
                    );
                    console.log('‚úÖ Supabase connected directly');
                } else {
                    throw new Error('No Supabase configuration available');
                }
                
                // Update status
                updateDbStatus('connected', '‚úÖ Database: Connected');
                
            } catch (error) {
                console.error('‚ùå Supabase connection failed:', error);
                updateDbStatus('disconnected', '‚ùå Database: Failed');
                throw error;
            }
        }

        // =============================================
        // COMPETITIONS - DATABASE QUERIES ONLY
        // =============================================

        async function loadCompetitionsFromDatabase() {
            try {
                console.log('üìä Loading competitions from database...');
                
                if (!globalState.supabase) {
                    throw new Error('Database not connected');
                }

                // Query competitions table directly
                const { data: competitions, error } = await globalState.supabase
                    .from('competitions')
                    .select(`
                        *,
                        token_pairs (
                            token_a_symbol,
                            token_b_symbol,
                            token_a_name,
                            token_b_name
                        )
                    `)
                    .order('created_at', { ascending: false });

                if (error) {
                    throw error;
                }

                console.log(`‚úÖ Loaded ${competitions?.length || 0} competitions from database`);
                
                globalState.competitions = competitions || [];
                return competitions || [];
                
            } catch (error) {
                console.error('‚ùå Failed to load competitions:', error);
                showNotification('Failed to load competitions from database', 'error');
                return [];
            }
        }

        async function getCurrentTokenPrices(tokenAddresses) {
            try {
                if (!globalState.supabase || !tokenAddresses || tokenAddresses.length === 0) {
                    return {};
                }

                // Query token_cache table for current prices
                const { data: tokenPrices, error } = await globalState.supabase
                    .from('token_cache')
                    .select('token_address, current_price, price_change_24h, symbol, name, logo_uri')
                    .in('token_address', tokenAddresses)
                    .eq('cache_status', 'FRESH');

                if (error) {
                    throw error;
                }

                // Convert to lookup object
                const pricesLookup = {};
                tokenPrices?.forEach(token => {
                    pricesLookup[token.token_address] = {
                        price: token.current_price,
                        change24h: token.price_change_24h,
                        symbol: token.symbol,
                        name: token.name,
                        logo: token.logo_uri
                    };
                });

                return pricesLookup;
                
            } catch (error) {
                console.error('‚ùå Failed to load token prices:', error);
                return {};
            }
        }

        async function renderCompetitions() {
            try {
                console.log('üé® Rendering competitions...');
                
                const competitions = await loadCompetitionsFromDatabase();
                const grid = document.getElementById('competitionsGrid');
                
                if (!grid) {
                    console.error('Competitions grid not found');
                    return;
                }

                if (competitions.length === 0) {
                    grid.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üèÜ</div>
                            <h3>No Competitions Available</h3>
                            <p>Competitions are created by administrators. Check back soon for new prediction opportunities!</p>
                        </div>
                    `;
                    updateCompetitionStats(competitions);
                    return;
                }

                // Get token prices for all competition tokens
                const tokenAddresses = new Set();
                competitions.forEach(comp => {
                    tokenAddresses.add(comp.token_a_address);
                    tokenAddresses.add(comp.token_b_address);
                });
                
                const tokenPrices = await getCurrentTokenPrices(Array.from(tokenAddresses));

                // Apply filters
                const filteredCompetitions = applyCompetitionFilters(competitions);

                // Render competition cards
                grid.innerHTML = filteredCompetitions.map(competition => 
                    createCompetitionCard(competition, tokenPrices)
                ).join('');

                // Update statistics
                updateCompetitionStats(competitions);
                
                console.log(`‚úÖ Rendered ${filteredCompetitions.length} competitions`);
                
            } catch (error) {
                console.error('‚ùå Error rendering competitions:', error);
                const grid = document.getElementById('competitionsGrid');
                if (grid) {
                    grid.innerHTML = `
                        <div class="error-state">
                            <div class="error-icon">‚ùå</div>
                            <h3>Failed to Load Competitions</h3>
                            <p>Unable to load competitions from database. Please try refreshing the page.</p>
                            <button class="btn-primary" onclick="refreshCompetitions()">Retry</button>
                        </div>
                    `;
                }
            }
        }

        function createCompetitionCard(competition, tokenPrices) {
            const tokenA = tokenPrices[competition.token_a_address] || {};
            const tokenB = tokenPrices[competition.token_b_address] || {};
            
            const statusClass = competition.status.toLowerCase();
            const timeInfo = getCompetitionTimeInfo(competition);
            
            return `
                <div class="competition-card" onclick="openCompetitionModal('${competition.competition_id}')">
                    <div class="competition-header">
                        <div class="competition-status ${statusClass}">
                            ${getStatusIcon(competition.status)} ${competition.status}
                        </div>
                        <div class="data-indicator">
                            <div class="data-dot live"></div>
                            Live Data
                        </div>
                    </div>
                    
                    <div class="token-battle">
                        <div class="token-info">
                            ${tokenA.logo ? `<img src="${tokenA.logo}" alt="${competition.token_a_symbol}" class="token-logo">` : 
                              `<div class="token-logo-placeholder">${competition.token_a_symbol?.charAt(0) || 'T'}</div>`}
                            <div class="token-symbol">${competition.token_a_symbol || 'Unknown'}</div>
                            <div class="token-name">${competition.token_a_name || 'Token A'}</div>
                            ${tokenA.price ? `<div class="token-price">$${parseFloat(tokenA.price).toFixed(4)}</div>` : ''}
                            ${tokenA.change24h ? `<div class="price-change ${tokenA.change24h >= 0 ? 'positive' : 'negative'}">
                                ${tokenA.change24h >= 0 ? '+' : ''}${tokenA.change24h.toFixed(2)}%
                            </div>` : ''}
                        </div>
                        
                        <div class="vs-divider">
                            <div class="vs-text">VS</div>
                            <div class="competition-timer">
                                <div class="timer-label">${timeInfo.label}</div>
                                <div class="timer-value">${timeInfo.value}</div>
                            </div>
                        </div>
                        
                        <div class="token-info">
                            ${tokenB.logo ? `<img src="${tokenB.logo}" alt="${competition.token_b_symbol}" class="token-logo">` : 
                              `<div class="token-logo-placeholder">${competition.token_b_symbol?.charAt(0) || 'T'}</div>`}
                            <div class="token-symbol">${competition.token_b_symbol || 'Unknown'}</div>
                            <div class="token-name">${competition.token_b_name || 'Token B'}</div>
                            ${tokenB.price ? `<div class="token-price">$${parseFloat(tokenB.price).toFixed(4)}</div>` : ''}
                            ${tokenB.change24h ? `<div class="price-change ${tokenB.change24h >= 0 ? 'positive' : 'negative'}">
                                ${tokenB.change24h >= 0 ? '+' : ''}${tokenB.change24h.toFixed(2)}%
                            </div>` : ''}
                        </div>
                    </div>
                    
                    <div class="competition-stats">
                        <div class="stat-item">
                            <div class="stat-value">${competition.total_bets || 0}</div>
                            <div class="stat-label">Participants</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${parseFloat(competition.total_pool || 0).toFixed(1)} SOL</div>
                            <div class="stat-label">Prize Pool</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">0.1 SOL</div>
                            <div class="stat-label">Entry Fee</div>
                        </div>
                    </div>
                    
                    <div class="action-section">
                        ${getActionButton(competition)}
                    </div>
                </div>
            `;
        }

        function getStatusIcon(status) {
            const icons = {
                'SETUP': '‚è∞',
                'VOTING': 'üó≥Ô∏è',
                'ACTIVE': '‚ö°',
                'CLOSED': 'üèÅ',
                'RESOLVED': '‚úÖ'
            };
            return icons[status] || '‚ùì';
        }

        function getCompetitionTimeInfo(competition) {
            const now = new Date();
            const startTime = new Date(competition.start_time);
            const votingEndTime = new Date(competition.voting_end_time);
            const endTime = new Date(competition.end_time);

            if (competition.status === 'SETUP') {
                const timeUntilStart = startTime - now;
                return {
                    label: 'STARTS IN',
                    value: formatTimeRemaining(timeUntilStart)
                };
            } else if (competition.status === 'VOTING') {
                const timeUntilVotingEnd = votingEndTime - now;
                return {
                    label: 'VOTING ENDS',
                    value: formatTimeRemaining(timeUntilVotingEnd)
                };
            } else if (competition.status === 'ACTIVE') {
                const timeUntilEnd = endTime - now;
                return {
                    label: 'ENDS IN',
                    value: formatTimeRemaining(timeUntilEnd)
                };
            } else {
                return {
                    label: 'COMPLETED',
                    value: new Date(competition.end_time).toLocaleDateString()
                };
            }
        }

        function formatTimeRemaining(milliseconds) {
            if (milliseconds <= 0) return 'Ended';
            
            const days = Math.floor(milliseconds / (1000 * 60 * 60 * 24));
            const hours = Math.floor((milliseconds % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((milliseconds % (1000 * 60 * 60)) / (1000 * 60));
            
            if (days > 0) return `${days}d ${hours}h`;
            if (hours > 0) return `${hours}h ${minutes}m`;
            return `${minutes}m`;
        }

        function getActionButton(competition) {
            if (!globalState.isConnected) {
                return `
                    <button class="action-button" onclick="event.stopPropagation(); openWalletModal()">
                        Connect to Participate
                    </button>
                `;
            }

            switch (competition.status) {
                case 'VOTING':
                    return `
                        <button class="action-button">
                            Place Prediction
                        </button>
                    `;
                case 'ACTIVE':
                    return `
                        <button class="action-button" disabled>
                            Competition Running
                        </button>
                    `;
                case 'CLOSED':
                case 'RESOLVED':
                    return `
                        <button class="action-button" disabled>
                            View Results
                        </button>
                    `;
                default:
                    return `
                        <button class="action-button" disabled>
                            Opening Soon
                        </button>
                    `;
            }
        }

        function applyCompetitionFilters(competitions) {
            let filtered = [...competitions];

            // Filter by phase
            if (globalState.filters.phase !== 'all') {
                const statusMap = {
                    'voting': ['VOTING'],
                    'active': ['ACTIVE'],
                    'completed': ['CLOSED', 'RESOLVED']
                };
                const allowedStatuses = statusMap[globalState.filters.phase];
                if (allowedStatuses) {
                    filtered = filtered.filter(comp => allowedStatuses.includes(comp.status));
                }
            }

            // Sort
            filtered.sort((a, b) => {
                switch (globalState.filters.sortBy) {
                    case 'total_pool':
                        return parseFloat(b.total_pool || 0) - parseFloat(a.total_pool || 0);
                    case 'total_bets':
                        return (b.total_bets || 0) - (a.total_bets || 0);
                    case 'start_time':
                    default:
                        return new Date(b.start_time) - new Date(a.start_time);
                }
            });

            return filtered;
        }

        function updateCompetitionStats(competitions) {
            const stats = {
                total: competitions.length,
                active: competitions.filter(c => ['VOTING', 'ACTIVE'].includes(c.status)).length,
                participants: competitions.reduce((sum, c) => sum + (c.total_bets || 0), 0),
                prizePool: competitions.reduce((sum, c) => sum + parseFloat(c.total_pool || 0), 0)
            };

            updateElementSafely('totalCompetitions', stats.total);
            updateElementSafely('activeCompetitions', stats.active);
            updateElementSafely('totalParticipants', stats.participants);
            updateElementSafely('totalPrizePool', `${stats.prizePool.toFixed(1)} SOL`);
        }

        // =============================================
        // LEADERBOARD - DATABASE QUERIES ONLY
        // =============================================

        async function loadLeaderboardFromDatabase() {
            try {
                console.log('üèÜ Loading leaderboard from database...');
                
                if (!globalState.supabase) {
                    throw new Error('Database not connected');
                }

                // Query users table directly
                const { data: users, error } = await globalState.supabase
                    .from('users')
                    .select('*')
                    .order('total_winnings', { ascending: false })
                    .limit(100);

                if (error) {
                    throw error;
                }

                console.log(`‚úÖ Loaded ${users?.length || 0} users for leaderboard`);
                
                globalState.users = users || [];
                return users || [];
                
            } catch (error) {
                console.error('‚ùå Failed to load leaderboard:', error);
                showNotification('Failed to load leaderboard from database', 'error');
                return [];
            }
        }

        async function renderLeaderboard() {
            try {
                console.log('üé® Rendering leaderboard...');
                
                const users = await loadLeaderboardFromDatabase();
                const table = document.getElementById('leaderboardTable');
                
                if (!table) {
                    console.error('Leaderboard table not found');
                    return;
                }

                if (users.length === 0) {
                    table.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üë•</div>
                            <h3>No Traders Yet</h3>
                            <p>Be the first to join competitions and appear on the leaderboard!</p>
                        </div>
                    `;
                    return;
                }

                // Apply filters and render
                const filteredUsers = applyLeaderboardFilters(users);
                
                table.innerHTML = `
                    <div class="leaderboard-header">
                        <div class="rank-col">Rank</div>
                        <div class="trader-col">Trader</div>
                        <div class="winnings-col">Winnings</div>
                        <div class="stats-col">Win Rate</div>
                        <div class="competitions-col">Competitions</div>
                        <div class="streak-col">Streak</div>
                    </div>
                    ${filteredUsers.map((user, index) => createLeaderboardRow(user, index + 1)).join('')}
                `;
                
                console.log(`‚úÖ Rendered ${filteredUsers.length} leaderboard entries`);
                
            } catch (error) {
                console.error('‚ùå Error rendering leaderboard:', error);
                const table = document.getElementById('leaderboardTable');
                if (table) {
                    table.innerHTML = `
                        <div class="error-state">
                            <div class="error-icon">‚ùå</div>
                            <h3>Failed to Load Leaderboard</h3>
                            <p>Unable to load leaderboard from database.</p>
                            <button class="btn-primary" onclick="refreshLeaderboard()">Retry</button>
                        </div>
                    `;
                }
            }
        }

        function createLeaderboardRow(user, rank) {
            const isTop3 = rank <= 3;
            const rankIcons = ['ü•á', 'ü•à', 'ü•â'];
            const rankDisplay = isTop3 ? rankIcons[rank - 1] : `#${rank}`;

            return `
                <div class="leaderboard-row ${isTop3 ? 'top-3' : ''}">
                    <div class="rank-col">${rankDisplay}</div>
                    <div class="trader-col">
                        <div class="trader-info">
                            <div class="trader-name">${user.username || 'Anonymous'}</div>
                            <div class="trader-address">${formatAddress(user.wallet_address)}</div>
                        </div>
                    </div>
                    <div class="winnings-col">
                        <div class="winnings-amount">${parseFloat(user.total_winnings || 0).toFixed(2)} SOL</div>
                    </div>
                    <div class="stats-col">
                        <div class="win-rate">${parseFloat(user.win_rate || 0).toFixed(1)}%</div>
                        <div class="total-bets">${user.total_bets || 0} bets</div>
                    </div>
                    <div class="competitions-col">
                        <div class="competitions-count">${user.total_bets || 0}</div>
                    </div>
                    <div class="streak-col">
                        <div class="current-streak ${(user.current_streak || 0) > 0 ? 'positive' : ''}">${user.current_streak || 0}</div>
                    </div>
                </div>
            `;
        }

        function applyLeaderboardFilters(users) {
            // Apply time period filters if needed
            // For now, return all users sorted by the selected criteria
            return [...users].sort((a, b) => {
                switch (globalState.filters.leaderboardSort || 'total_winnings') {
                    case 'win_rate':
                        return parseFloat(b.win_rate || 0) - parseFloat(a.win_rate || 0);
                    case 'current_streak':
                        return (b.current_streak || 0) - (a.current_streak || 0);
                    case 'total_bets':
                        return (b.total_bets || 0) - (a.total_bets || 0);
                    case 'total_winnings':
                    default:
                        return parseFloat(b.total_winnings || 0) - parseFloat(a.total_winnings || 0);
                }
            });
        }

        // =============================================
        // PORTFOLIO - DATABASE QUERIES ONLY
        // =============================================

        async function loadPortfolioFromDatabase() {
            try {
                console.log('üìä Loading portfolio from database...');
                
                if (!globalState.isConnected || !globalState.currentUser) {
                    showPortfolioConnectPrompt();
                    return;
                }

                if (!globalState.supabase) {
                    throw new Error('Database not connected');
                }

                // Get user's betting history
                const { data: userBets, error: betsError } = await globalState.supabase
                    .from('bets')
                    .select(`
                        *,
                        competitions (
                            token_a_symbol,
                            token_b_symbol,
                            status,
                            start_time,
                            end_time
                        )
                    `)
                    .eq('user_wallet', globalState.currentUser.wallet_address)
                    .order('timestamp', { ascending: false });

                if (betsError) {
                    throw betsError;
                }

                // Get user profile
                const { data: userProfile, error: profileError } = await globalState.supabase
                    .from('users')
                    .select('*')
                    .eq('wallet_address', globalState.currentUser.wallet_address)
                    .single();

                if (profileError) {
                    throw profileError;
                }

                renderPortfolio(userProfile, userBets || []);
                
            } catch (error) {
                console.error('‚ùå Failed to load portfolio:', error);
                showPortfolioError();
            }
        }

        function renderPortfolio(userProfile, userBets) {
            const content = document.getElementById('portfolio-content');
            if (!content) return;

            const stats = calculatePortfolioStats(userProfile, userBets);

            content.innerHTML = `
                <div class="portfolio-overview">
                    <div class="portfolio-stats">
                        <div class="stat-card">
                            <div class="stat-icon">üí∞</div>
                            <div class="stat-content">
                                <div class="stat-value">${stats.totalWinnings.toFixed(2)} SOL</div>
                                <div class="stat-label">Total Winnings</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üìä</div>
                            <div class="stat-content">
                                <div class="stat-value">${stats.winRate.toFixed(1)}%</div>
                                <div class="stat-label">Win Rate</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üèÜ</div>
                            <div class="stat-content">
                                <div class="stat-value">${stats.totalBets}</div>
                                <div class="stat-label">Total Bets</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üî•</div>
                            <div class="stat-content">
                                <div class="stat-value">${stats.currentStreak}</div>
                                <div class="stat-label">Current Streak</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="betting-history">
                        <h3>Betting History</h3>
                        ${userBets.length === 0 ? 
                            `<div class="empty-state">
                                <p>No betting history yet. Join a competition to get started!</p>
                            </div>` :
                            `<div class="bets-list">
                                ${userBets.map(bet => createBetHistoryItem(bet)).join('')}
                            </div>`
                        }
                    </div>
                </div>
            `;
        }

        function calculatePortfolioStats(userProfile, userBets) {
            return {
                totalWinnings: parseFloat(userProfile.total_winnings || 0),
                winRate: parseFloat(userProfile.win_rate || 0),
                totalBets: parseInt(userProfile.total_bets || 0),
                currentStreak: parseInt(userProfile.current_streak || 0)
            };
        }

        function createBetHistoryItem(bet) {
            const competition = bet.competitions;
            const statusClass = bet.status?.toLowerCase() || 'placed';
            
            return `
                <div class="bet-item">
                    <div class="bet-competition">
                        ${competition?.token_a_symbol || 'Unknown'} vs ${competition?.token_b_symbol || 'Unknown'}
                    </div>
                    <div class="bet-details">
                        <span class="bet-amount">${parseFloat(bet.amount || 0).toFixed(2)} SOL</span>
                        <span class="bet-choice">on ${bet.chosen_token === 'token_a' ? competition?.token_a_symbol : competition?.token_b_symbol}</span>
                    </div>
                    <div class="bet-status ${statusClass}">${bet.status || 'Placed'}</div>
                    <div class="bet-date">${new Date(bet.timestamp).toLocaleDateString()}</div>
                </div>
            `;
        }

        function showPortfolioConnectPrompt() {
            const content = document.getElementById('portfolio-content');
            if (content) {
                content.innerHTML = `
                    <div class="connect-prompt">
                        <div class="prompt-icon">üîó</div>
                        <h3>Connect Wallet to View Portfolio</h3>
                        <p>Connect your wallet to see your prediction history and statistics</p>
                        <button class="btn-primary" onclick="openWalletModal()">Connect Wallet</button>
                    </div>
                `;
            }
        }

        function showPortfolioError() {
            const content = document.getElementById('portfolio-content');
            if (content) {
                content.innerHTML = `
                    <div class="error-state">
                        <div class="error-icon">‚ùå</div>
                        <h3>Failed to Load Portfolio</h3>
                        <p>Unable to load portfolio data from database.</p>
                        <button class="btn-primary" onclick="refreshPortfolioData()">Retry</button>
                    </div>
                `;
            }
        }

        // =============================================
        // NAVIGATION & UI MANAGEMENT
        // =============================================

        function initializeNavigation() {
            // Set up page navigation
            updatePageFromHash();
            
            // Handle hash changes
            window.addEventListener('hashchange', updatePageFromHash);
            
            // Handle popstate
            window.addEventListener('popstate', updatePageFromHash);
        }

        function updatePageFromHash() {
            const hash = window.location.hash.substring(1) || 'home';
            const validPages = ['home', 'competitions', 'leaderboard', 'portfolio'];
            
            if (validPages.includes(hash)) {
                showPage(hash, false);
            } else {
                showPage('home');
            }
        }

        function showPage(pageName, updateHash = true) {
            console.log(`üìÑ Navigating to page: ${pageName}`);
            
            // Update global state
            globalState.currentPage = pageName;
            
            // Hide all pages
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show target page
            const targetPage = document.getElementById(`${pageName}Page`);
            if (targetPage) {
                targetPage.classList.add('active');
            }
            
            // Update navigation
            updateActiveNavLink(pageName);
            
            // Update hash
            if (updateHash) {
                window.location.hash = pageName;
            }
            
            // Load page-specific content
            loadPageContent(pageName);
        }

        function updateActiveNavLink(activePageName) {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            const activeLink = document.querySelector(`[data-page="${activePageName}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
        }

        async function loadPageContent(pageName) {
            console.log(`üì¶ Loading content for page: ${pageName}`);
            
            // Update UI based on connection state first
            updateUIForConnectionState();
            
            // Load page-specific content
            switch (pageName) {
                case 'competitions':
                    if (globalState.isConnected) {
                        await renderCompetitions();
                    }
                    break;
                case 'leaderboard':
                    await renderLeaderboard();
                    break;
                case 'portfolio':
                    await loadPortfolioFromDatabase();
                    break;
                case 'home':
                    // Home page content is static
                    break;
            }
        }

        // =============================================
        // WALLET CONNECTION HANDLING
        // =============================================

        function setupWalletHandlers() {
            // Set up wallet connect button handlers
            document.querySelectorAll('.wallet-connect-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    openWalletModal();
                });
            });
        }

        function updateUIForConnectionState() {
            const isConnected = globalState.isConnected;
            
            // Update navigation
            const connectBtn = document.getElementById('connectWalletBtn');
            const traderInfo = document.getElementById('traderInfo');
            
            if (connectBtn && traderInfo) {
                if (isConnected) {
                    connectBtn.style.display = 'none';
                    traderInfo.style.display = 'block';
                    updateTraderInfo();
                } else {
                    connectBtn.style.display = 'block';
                    traderInfo.style.display = 'none';
                }
            }
            
            // Update hero sections
            const heroDisconnected = document.getElementById('heroDisconnected');
            const heroConnected = document.getElementById('heroConnected');
            
            if (heroDisconnected && heroConnected) {
                if (isConnected) {
                    heroDisconnected.style.display = 'none';
                    heroConnected.style.display = 'block';
                    updateHeroTraderName();
                } else {
                    heroDisconnected.style.display = 'block';
                    heroConnected.style.display = 'none';
                }
            }
            
            // Update competitions view
            updateCompetitionsView();
        }

        function updateTraderInfo() {
            if (!globalState.currentUser) return;
            
            const navTraderName = document.getElementById('navTraderName');
            const navTraderAvatar = document.getElementById('navTraderAvatar');
            const navTraderBalance = document.getElementById('navTraderBalance');
            
            if (navTraderName) navTraderName.textContent = globalState.currentUser.username || 'Trader';
            if (navTraderAvatar) navTraderAvatar.textContent = globalState.currentUser.avatar || 'üéØ';
            if (navTraderBalance) navTraderBalance.textContent = `${(globalState.currentUser.balance || 0).toFixed(2)} SOL`;
        }

        function updateHeroTraderName() {
            const heroTraderNameText = document.getElementById('heroTraderNameText');
            if (heroTraderNameText && globalState.currentUser) {
                heroTraderNameText.textContent = globalState.currentUser.username || 'Trader';
            }
        }

        function updateCompetitionsView() {
            const connectedView = document.getElementById('competitionsConnected');
            const disconnectedView = document.getElementById('competitionsDisconnected');
            
            if (connectedView && disconnectedView) {
                if (globalState.isConnected) {
                    connectedView.style.display = 'block';
                    disconnectedView.style.display = 'none';
                } else {
                    connectedView.style.display = 'none';
                    disconnectedView.style.display = 'block';
                }
            }
        }

        // =============================================
        // EVENT HANDLERS & UTILITY FUNCTIONS
        // =============================================

        function handleCompetitionFilterChange() {
            const phaseSelect = document.getElementById('competition-phase');
            const sortSelect = document.getElementById('sort-by');
            
            if (phaseSelect) globalState.filters.phase = phaseSelect.value;
            if (sortSelect) globalState.filters.sortBy = sortSelect.value;
            
            if (globalState.currentPage === 'competitions') {
                renderCompetitions();
            }
        }

        function handleLeaderboardFilterChange() {
            const sortSelect = document.getElementById('leaderboard-sort');
            
            if (sortSelect) globalState.filters.leaderboardSort = sortSelect.value;
            
            if (globalState.currentPage === 'leaderboard') {
                renderLeaderboard();
            }
        }

        function handlePortfolioViewChange() {
            // Portfolio view changes can be handled here
            if (globalState.currentPage === 'portfolio') {
                loadPortfolioFromDatabase();
            }
        }

        async function refreshCompetitions() {
            console.log('üîÑ Refreshing competitions...');
            await renderCompetitions();
            showNotification('Competitions refreshed', 'success');
        }

        async function refreshLeaderboard() {
            console.log('üîÑ Refreshing leaderboard...');
            await renderLeaderboard();
            showNotification('Leaderboard refreshed', 'success');
        }

        async function refreshPortfolioData() {
            console.log('üîÑ Refreshing portfolio...');
            await loadPortfolioFromDatabase();
            showNotification('Portfolio refreshed', 'success');
        }

        function scrollToLearnMore() {
            const learnMoreSection = document.getElementById('learnMoreSection');
            if (learnMoreSection) {
                learnMoreSection.scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        }

        // =============================================
        // MODAL FUNCTIONS (Placeholder)
        // =============================================

        function openCompetitionModal(competitionId) {
            console.log('üéØ Opening competition modal:', competitionId);
            // Modal implementation would go here
            showNotification('Competition details modal - feature coming soon', 'info');
        }

        function closeCompetitionModal() {
            const modal = document.getElementById('competitionModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function openWalletModal() {
            console.log('üîó Opening wallet modal...');
            // This would integrate with existing wallet service
            showNotification('Please connect your wallet using the wallet service', 'info');
        }

        function closeWalletModal() {
            const modal = document.getElementById('walletModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function disconnectWallet() {
            globalState.isConnected = false;
            globalState.currentUser = null;
            updateUIForConnectionState();
            showNotification('Wallet disconnected', 'info');
        }

        // =============================================
        // UTILITY FUNCTIONS
        // =============================================

        function updateElementSafely(id, value) {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
            }
        }

        function updateDbStatus(status, message) {
            const statusElement = document.getElementById('dbStatus');
            if (statusElement) {
                statusElement.className = `db-status ${status}`;
                statusElement.textContent = message;
            }
        }

        function formatAddress(address) {
            if (!address) return 'Unknown';
            return `${address.slice(0, 4)}...${address.slice(-4)}`;
        }

        function showNotification(message, type = 'info') {
            console.log(`üì¢ [${type.toUpperCase()}] ${message}`);
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#3b82f6'};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 0.5rem;
                z-index: 9999;
                max-width: 400px;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // =============================================
        // GLOBAL EXPORTS & INITIALIZATION
        // =============================================

        // Export functions for global use
        window.showPage = showPage;
        window.refreshCompetitions = refreshCompetitions;
        window.refreshLeaderboard = refreshLeaderboard;
        window.refreshPortfolioData = refreshPortfolioData;
        window.handleCompetitionFilterChange = handleCompetitionFilterChange;
        window.handleLeaderboardFilterChange = handleLeaderboardFilterChange;
        window.handlePortfolioViewChange = handlePortfolioViewChange;
        window.openCompetitionModal = openCompetitionModal;
        window.closeCompetitionModal = closeCompetitionModal;
        window.openWalletModal = openWalletModal;
        window.closeWalletModal = closeWalletModal;
        window.disconnectWallet = disconnectWallet;
        window.scrollToLearnMore = scrollToLearnMore;

        // Initialize application when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ DOM loaded, initializing database-centric TokenWars...');
            initializeDatabaseApp();
        });

        console.log('‚úÖ Database-Centric TokenWars Application Loaded');
        console.log('üóÑÔ∏è Features:');
        console.log('   ‚úÖ Direct database queries only (no service layer)');
        console.log('   ‚úÖ Real-time data from token_cache and competitions tables');
        console.log('   ‚úÖ No demo/fallback data - database-driven only');
        console.log('   ‚úÖ Competition display with live token prices');
        console.log('   ‚úÖ Leaderboard from users table');
        console.log('   ‚úÖ Portfolio from bets and users tables');
        console.log('   ‚úÖ Wallet integration preserved');
        console.log('   ‚úÖ Responsive UI with database status indicators');
        console.log('   ‚ùå No competition-manager.js dependency');
        console.log('   ‚ùå No service layer complexity');
        console.log('   ‚ùå No demo data or fallbacks');
    </script>
    
    <!-- Competition Card Styling -->
    <style>
        /* Competition Card Styles */
        .competitions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 2rem;
            margin-top: 1.5rem;
        }

        .competition-card {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(236, 72, 153, 0.05));
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 1.25rem;
            padding: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .competition-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent-purple);
            box-shadow: 0 15px 35px rgba(139, 92, 246, 0.2);
        }

        .competition-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-purple), var(--accent-pink));
        }

        .competition-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .competition-status {
            padding: 0.25rem 0.75rem;
            border-radius: 2rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .competition-status.voting {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #22c55e;
        }

        .competition-status.active {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: #f59e0b;
        }

        .data-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .data-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .data-dot.live {
            background: #22c55e;
            box-shadow: 0 0 4px #22c55e;
        }

        .token-battle {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: rgba(15, 23, 42, 0.3);
            border-radius: 0.75rem;
        }

        .token-info {
            text-align: center;
        }

        .token-logo, .token-logo-placeholder {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            margin: 0 auto 0.5rem;
            object-fit: cover;
        }

        .token-logo-placeholder {
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
        }

        .token-symbol {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .token-name {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .token-price {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .price-change {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            margin-top: 0.25rem;
        }

        .price-change.positive {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
        }

        .price-change.negative {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .vs-divider {
            text-align: center;
        }

        .vs-text {
            font-size: 1.2rem;
            font-weight: 900;
            color: var(--accent-purple);
            margin-bottom: 0.5rem;
        }

        .competition-timer {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .timer-label {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .timer-value {
            color: var(--text-primary);
            font-weight: 700;
        }

        .competition-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .action-button {
            width: 100%;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink));
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
        }

        .action-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Loading and Error States */
        .loading-state, .empty-state, .error-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            text-align: center;
            color: var(--text-secondary);
        }

        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid rgba(139, 92, 246, 0.2);
            border-top: 3px solid var(--accent-purple);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-icon, .error-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.7;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(236, 72, 153, 0.1));
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 1rem;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            border-color: rgba(139, 92, 246, 0.4);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.15);
        }

        .stat-icon {
            font-size: 2rem;
            flex-shrink: 0;
        }

        .stat-content {
            flex: 1;
        }

        /* Leaderboard Styles */
        .leaderboard-header {
            display: grid;
            grid-template-columns: 60px 1fr 120px 120px 120px 100px;
            gap: 1rem;
            padding: 1rem;
            background: rgba(139, 92, 246, 0.1);
            border-radius: 0.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .leaderboard-row {
            display: grid;
            grid-template-columns: 60px 1fr 120px 120px 120px 100px;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid rgba(139, 92, 246, 0.1);
            transition: background 0.2s ease;
        }

        .leaderboard-row:hover {
            background: rgba(139, 92, 246, 0.05);
        }

        .leaderboard-row.top-3 {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 215, 0, 0.05));
        }

        /* Portfolio Styles */
        .portfolio-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .betting-history h3 {
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .bets-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .bet-item {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            gap: 1rem;
            padding: 1rem;
            background: rgba(139, 92, 246, 0.05);
            border-radius: 0.5rem;
            align-items: center;
        }

        .bet-status {
            padding: 0.25rem 0.75rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .bet-status.won {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .bet-status.lost {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .bet-status.pending {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        /* Connect Prompt */
        .connect-prompt {
            text-align: center;
            padding: 4rem 2rem;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.05), rgba(236, 72, 153, 0.05));
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 1.5rem;
        }

        .prompt-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            opacity: 0.7;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .competitions-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
            
            .token-battle {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .vs-divider {
                order: -1;
            }
            
            .competition-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .leaderboard-header,
            .leaderboard-row {
                grid-template-columns: 50px 1fr 80px 80px;
                font-size: 0.875rem;
            }

            .bet-item {
                grid-template-columns: 1fr;
                text-align: center;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .competition-stats {
                grid-template-columns: 1fr;
            }

            .portfolio-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</body>
</html>
